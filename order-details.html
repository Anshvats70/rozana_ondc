<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - Rozana ONDC</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 2rem;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .content {
            padding: 2rem;
        }

        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #dc2626;
        }

        .error-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 1.5rem;
            border-left: 4px solid #4f46e5;
        }

        .info-card h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #64748b;
        }

        .info-value {
            font-weight: 500;
            color: #1e293b;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-confirmed {
            background: #dcfce7;
            color: #166534;
        }

        .status-completed {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-draft {
            background: #f3f4f6;
            color: #6b7280;
        }

        .order-items {
            background: white;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .order-items h3 {
            background: #f8fafc;
            padding: 1.5rem;
            margin: 0;
            color: #1e293b;
            border-bottom: 1px solid #e2e8f0;
        }

        .item-list {
            padding: 1.5rem;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .item:last-child {
            margin-bottom: 0;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .item-meta {
            font-size: 0.875rem;
            color: #64748b;
        }

        .item-price {
            font-weight: 600;
            color: #4f46e5;
            font-size: 1.1rem;
        }

        .issue-card {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .issue-card.processing {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .issue-card.resolved {
            background: #dcfce7;
            border-color: #10b981;
        }

        .issue-card.closed {
            background: #f3f4f6;
            border-color: #6b7280;
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .issue-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .issue-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .issue-status.open {
            background: #fef3c7;
            color: #92400e;
        }

        .issue-status.processing {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .issue-status.resolved {
            background: #dcfce7;
            color: #166534;
        }

        .issue-status.closed {
            background: #f3f4f6;
            color: #6b7280;
        }


        /* Progress Bar Timeline Styles */
        .issue-timeline-progress {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .timeline-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .timeline-progress {
            font-size: 0.875rem;
            color: #64748b;
        }

        .progress-container {
            position: relative;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 4px;
            transition: width 0.8s ease-in-out;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .timeline-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            position: relative;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            position: relative;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .step-circle.completed {
            background: #10b981;
            color: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .step-circle.current {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            animation: pulse 2s infinite;
        }

        .step-circle.pending {
            background: #e2e8f0;
            color: #64748b;
            border: 2px solid #cbd5e1;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.1); }
        }

        .step-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            max-width: 80px;
            line-height: 1.2;
        }

        .step-label.completed {
            color: #10b981;
            font-weight: 600;
        }

        .step-label.current {
            color: #3b82f6;
            font-weight: 600;
        }

        .step-date {
            font-size: 0.625rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .timeline-connector {
            position: absolute;
            top: 16px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .timeline-connector-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.8s ease-in-out;
        }

        /* Responsive timeline */
        @media (max-width: 768px) {
            .timeline-steps {
                flex-direction: column;
                gap: 1rem;
            }
            
            .timeline-step {
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                width: 100%;
            }
            
            .step-circle {
                margin-right: 1rem;
                margin-bottom: 0;
            }
            
            .timeline-connector {
                display: none;
            }
        }

        /* Accept Proposal Button Styles */
        .proposal-actions {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 10px;
        }

        .proposal-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .proposal-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-left: 0.5rem;
        }

        .proposal-description {
            color: #475569;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .accept-proposal-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .accept-proposal-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .accept-proposal-btn:active {
            transform: translateY(0);
        }

        .accept-proposal-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .accept-proposal-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .resolution-details {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .resolution-item {
            margin-bottom: 0.5rem;
        }

        .resolution-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .resolution-value {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .resolution-tags-container {
            margin-top: 0.5rem;
        }

        .resolution-tag {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .resolution-tag:last-child {
            margin-bottom: 0;
        }

        .tag-descriptor {
            margin-bottom: 0.5rem;
        }

        .tag-descriptor:last-child {
            margin-bottom: 0;
        }

        /* Raise Issue Button Styles */
        .raise-issue-container {
            text-align: center;
            padding: 2rem;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
        }

        .raise-issue-description {
            color: #92400e;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .raise-issue-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        .raise-issue-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .raise-issue-btn:active {
            transform: translateY(0);
        }

        /* Issue Close Button Styles */
        .issue-close-container {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #fef2f2;
            border: 1px solid #dc2626;
            border-radius: 10px;
            text-align: center;
        }

        .issue-close-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .issue-close-title {
            font-weight: 600;
            color: #dc2626;
            margin-left: 0.5rem;
        }

        .issue-close-description {
            color: #dc2626;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .close-issue-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }

        .close-issue-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        .close-issue-btn:active {
            transform: translateY(0);
        }

        .close-issue-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .close-issue-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Issue Status Button Styles */
        .issue-status-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .issue-status-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .issue-status-btn:active {
            transform: translateY(0);
        }

        .issue-status-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .issue-status-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Info Request Response Styles */
        .info-request-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 10px;
        }

        .info-request-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .info-request-title {
            font-weight: 600;
            color: #1e40af;
            margin-left: 0.5rem;
        }

        .info-request-description {
            color: #1e40af;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .file-upload-area.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .file-upload-icon {
            font-size: 2rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .file-upload-text {
            color: #374151;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .file-upload-hint {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            margin-top: 1rem;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-icon {
            color: #3b82f6;
        }

        .file-name {
            font-size: 0.9rem;
            color: #374151;
        }

        .file-size {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .remove-file-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .remove-file-btn:hover {
            background: #dc2626;
        }

        .submit-info-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .submit-info-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .submit-info-btn:active {
            transform: translateY(0);
        }

        .submit-info-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .refresh-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1.5rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .back-btn {
                position: static;
                margin-top: 1rem;
                width: 100%;
            }

            .content {
                padding: 1rem;
            }

            .order-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Order Details</h1>
            <p>Detailed information about your order</p>
            <button class="back-btn" onclick="window.close()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>

        <div class="content">
            <button id="refreshBtn" class="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh Details
            </button>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="loading-spinner"></div>
                <h3>Loading Order Details...</h3>
                <p>Fetching the latest information from the server</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Failed to Load Order Details</h3>
                <p id="errorMessage">Unable to fetch order information. Please try again.</p>
                <button onclick="window.orderDetailsManager.loadOrderDetails()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Retry
                </button>
            </div>

            <!-- Order Details Content -->
            <div id="orderContent" style="display: none;">
                <!-- Order Information Cards -->
                <div class="order-info">
                    <div class="info-card">
                        <h3><i class="fas fa-shopping-cart"></i> Order Information</h3>
                        <div class="info-item">
                            <span class="info-label">Order ID</span>
                            <span class="info-value" id="orderId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Transaction ID</span>
                            <span class="info-value" id="transactionId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ONDC Order ID</span>
                            <span class="info-value" id="ondcOrderId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status</span>
                            <span class="info-value" id="orderStatus">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="fas fa-credit-card"></i> Payment Information</h3>
                        <div class="info-item">
                            <span class="info-label">Total Amount</span>
                            <span class="info-value" id="totalAmount">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Payment Status</span>
                            <span class="info-value" id="paymentStatus">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Payment Mode</span>
                            <span class="info-value" id="paymentMode">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Currency</span>
                            <span class="info-value" id="currency">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="fas fa-store"></i> Provider Information</h3>
                        <div class="info-item">
                            <span class="info-label">Provider ID</span>
                            <span class="info-value" id="providerId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Provider Location</span>
                            <span class="info-value" id="providerLocation">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Items</span>
                            <span class="info-value" id="totalItems">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Quantity</span>
                            <span class="info-value" id="totalQuantity">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="fas fa-calendar"></i> Timeline</h3>
                        <div class="info-item">
                            <span class="info-label">Created At</span>
                            <span class="info-value" id="createdAt">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Updated At</span>
                            <span class="info-value" id="updatedAt">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Issue Raised</span>
                            <span class="info-value" id="issueRaised">-</span>
                        </div>
                    </div>
                </div>

                <!-- Issue Details (if available) -->
                <div id="issueDetailsSection" class="order-items" style="display: none;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Issue Details</h3>
                    <div class="item-list" id="issueDetailsList">
                        <!-- Issue details will be populated here -->
                    </div>
                </div>

                <!-- Raise Issue Button (for completed orders without issues) -->
                <div id="raiseIssueSection" class="order-items" style="display: none;">
                    <h3><i class="fas fa-flag"></i> Report an Issue</h3>
                    <div class="item-list" id="raiseIssueContainer">
                        <!-- Raise issue button will be populated here -->
                    </div>
                </div>

                <!-- Order Items -->
                <div class="order-items">
                    <h3><i class="fas fa-list"></i> Order Items</h3>
                    <div class="item-list" id="orderItemsList">
                        <!-- Items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class OrderDetailsManager {
            constructor() {
                this.apiUrl = 'https://neo-server.rozana.in/searchOrder/';
                this.proxyUrl = './api-proxy.php?url=';
                this.corsProxyUrl = 'https://api.allorigins.win/raw?url=';
                this.transactionId = null;
                this.orderId = null;
                this.orderData = null;
                
                this.init();
            }

            init() {
                console.log('🚀 OrderDetailsManager initialized');
                
                // Get transaction_id from URL parameters
                this.getUrlParameters();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load order details
                this.loadOrderDetails();
            }

            getUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                this.transactionId = urlParams.get('transaction_id');
                this.orderId = urlParams.get('order_id');
                
                console.log('📋 URL Parameters:', {
                    transactionId: this.transactionId,
                    orderId: this.orderId
                });

                // Also try to get from localStorage as fallback
                const storedOrder = localStorage.getItem('selectedOrder');
                if (storedOrder && !this.transactionId) {
                    const orderData = JSON.parse(storedOrder);
                    this.transactionId = orderData.transaction_id;
                    this.orderId = orderData.order_id;
                    console.log('📋 Using stored order data:', orderData);
                }
            }

            setupEventListeners() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadOrderDetails();
                });
            }

            async loadOrderDetails() {
                if (!this.transactionId) {
                    this.showError('No transaction ID provided');
                    return;
                }

                console.log(`📥 Loading order details for transaction: ${this.transactionId}`);
                console.log(`🔗 API URL will be: ${this.apiUrl}${this.transactionId}`);
                this.showLoading();

                try {
                    // Try multiple methods to fetch data (skip direct API for file:// protocol)
                    let orderData = null;
                    let successMethod = null;
                    const isFileProtocol = window.location.protocol === 'file:';

                    // Method 1: Try PHP proxy first (most reliable for CORS, skip for file:// protocol)
                    if (!isFileProtocol && window.location.origin !== 'null') {
                        try {
                            console.log('🔄 Trying PHP proxy (primary method)...');
                            const targetApiUrl = this.apiUrl + this.transactionId;
                            const proxyUrl = `${this.proxyUrl}${encodeURIComponent(targetApiUrl)}`;
                            console.log('📡 Target API URL:', targetApiUrl);
                            console.log('📡 PHP Proxy URL:', proxyUrl);
                            
                            const response = await fetch(proxyUrl, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                }
                            });

                            console.log('📡 PHP Proxy Response Status:', response.status);
                            console.log('📡 PHP Proxy Response Headers:', [...response.headers.entries()]);

                            if (response.ok) {
                                orderData = await response.json();
                                successMethod = 'PHP Proxy';
                                console.log('✅ PHP Proxy successful:', orderData);
                            } else {
                            console.log('❌ PHP Proxy HTTP Error:', response.status, response.statusText);
                            const errorText = await response.text();
                            console.log('❌ PHP Proxy Error Response:', errorText);
                        }
                        } catch (error) {
                            console.log('❌ PHP Proxy failed:', error.message);
                            console.log('❌ PHP Proxy Error Details:', error);
                        }
                    } else {
                        console.log('⚠️ Skipping PHP proxy (file:// protocol detected)');
                    }

                    // Method 2: Try AllOrigins CORS proxy if PHP proxy failed
                    if (!orderData) {
                        try {
                            console.log('🔄 Trying AllOrigins CORS proxy...');
                            const targetApiUrl = this.apiUrl + this.transactionId;
                            const corsUrl = `${this.corsProxyUrl}${encodeURIComponent(targetApiUrl)}`;
                            console.log('📡 CORS Proxy URL:', corsUrl);
                            
                            const response = await fetch(corsUrl, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                }
                            });

                            console.log('📡 CORS Proxy Response Status:', response.status);

                            if (response.ok) {
                                orderData = await response.json();
                                successMethod = 'AllOrigins CORS Proxy';
                                console.log('✅ CORS Proxy successful:', orderData);
                            } else {
                                console.log('❌ CORS Proxy HTTP Error:', response.status, response.statusText);
                            }
                        } catch (error) {
                            console.log('❌ CORS Proxy failed:', error.message);
                        }
                    }

                    // Method 3: Try direct API call only if not file:// protocol
                    if (!orderData && !isFileProtocol) {
                        try {
                            console.log('🔄 Trying direct API call...');
                            const directUrl = `${this.apiUrl}${this.transactionId}`;
                            console.log('📡 Direct API URL:', directUrl);
                            
                            const response = await fetch(directUrl, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json',
                                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                                    'Pragma': 'no-cache'
                                },
                                cache: 'no-store'
                            });

                            console.log('📡 Direct API Response Status:', response.status);

                            if (response.ok) {
                                orderData = await response.json();
                                successMethod = 'Direct API';
                                console.log('✅ Direct API successful:', orderData);
                            } else {
                                console.log('❌ Direct API HTTP Error:', response.status, response.statusText);
                            }
                        } catch (error) {
                            console.log('❌ Direct API failed (expected for file:// protocol):', error.message);
                        }
                    } else if (isFileProtocol) {
                        console.log('⚠️ Skipping direct API call (file:// protocol - CORS will block)');
                    }

                    if (!orderData) {
                        throw new Error('All API methods failed');
                    }

                    console.log(`📡 Order details loaded via ${successMethod}:`, orderData);
                    this.orderData = orderData;
                    this.displayOrderDetails(orderData);

                } catch (error) {
                    console.error('❌ Failed to load order details:', error);
                    
                    // Provide specific error message based on the issue
                    let errorMessage = 'Failed to load order details';
                    let suggestions = '';
                    
                    if (window.location.protocol === 'file:') {
                        errorMessage = 'CORS Error - Cannot load from file:// protocol';
                        suggestions = `
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
                                <h4 style="color: #92400e; margin-bottom: 0.5rem;">Solutions:</h4>
                                <ol style="margin: 0; padding-left: 1.5rem; color: #92400e;">
                                    <li><strong>Use XAMPP:</strong> Access via <code>http://localhost/rozana_ondc/order-details.html</code></li>
                                    <li><strong>Run local server:</strong> Double-click <code>start-server.bat</code></li>
                                    <li><strong>Use PHP proxy:</strong> Make sure XAMPP Apache is running</li>
                                </ol>
                            </div>
                        `;
                    } else {
                        suggestions = `
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
                                <h4 style="color: #dc2626; margin-bottom: 0.5rem;">Troubleshooting:</h4>
                                <ul style="margin: 0; padding-left: 1.5rem; color: #dc2626;">
                                    <li>Check if XAMPP Apache is running</li>
                                    <li>Verify API endpoint is accessible</li>
                                    <li>Check browser console for detailed errors</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    this.showError(`${errorMessage}: ${error.message}${suggestions}`);
                }
            }

            displayOrderDetails(data) {
                console.log('🎨 Displaying order details:', data);

                // Handle different response formats
                let orderInfo = data;
                if (data.success && data.data) {
                    orderInfo = data.data;
                } else if (data.order) {
                    orderInfo = data.order;
                }
                
                // Store current order data for fallback use
                this.currentOrderData = orderInfo;

                // Populate order information
                document.getElementById('orderId').textContent = orderInfo.order_id || '-';
                document.getElementById('transactionId').textContent = orderInfo.transaction_id || '-';
                document.getElementById('ondcOrderId').textContent = orderInfo.ondc_order_id || '-';
                
                // Order status with badge
                const statusElement = document.getElementById('orderStatus');
                const status = orderInfo.order_status || 'Unknown';
                statusElement.innerHTML = `<span class="status-badge status-${status.toLowerCase()}">${status}</span>`;

                // Payment information
                document.getElementById('totalAmount').textContent = this.formatCurrency(orderInfo.total_value, orderInfo.currency);
                document.getElementById('paymentStatus').textContent = orderInfo.payment_status || '-';
                document.getElementById('paymentMode').textContent = orderInfo.payment_mode || '-';
                document.getElementById('currency').textContent = orderInfo.currency || '-';

                // Provider information
                document.getElementById('providerId').textContent = orderInfo.provider_id || '-';
                document.getElementById('providerLocation').textContent = orderInfo.provider_location_id || '-';
                document.getElementById('totalItems').textContent = orderInfo.total_items || '0';
                document.getElementById('totalQuantity').textContent = orderInfo.total_quantity || '0';

                // Timeline
                document.getElementById('createdAt').textContent = this.formatDate(orderInfo.created_at);
                document.getElementById('updatedAt').textContent = this.formatDate(orderInfo.updated_at);
                document.getElementById('issueRaised').textContent = orderInfo.issue_raised ? 'Yes' : 'No';

                // Display order items
                this.displayOrderItems(orderInfo.order_details || orderInfo.items || []);

                // Display issue details if available
                this.displayIssueDetails(orderInfo);

                this.showContent();
            }

            displayOrderItems(items) {
                const itemsList = document.getElementById('orderItemsList');
                
                if (!items || items.length === 0) {
                    itemsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 2rem;">No items found</p>';
                    return;
                }

                itemsList.innerHTML = items.map(item => `
                    <div class="item">
                        <div class="item-details">
                            <div class="item-name">${item.title || item.name || 'Unknown Item'}</div>
                            <div class="item-meta">
                                Quantity: ${item.quantity || 0} | 
                                Status: ${item.status || 'Unknown'} |
                                ID: ${item.item_id || item.id || '-'}
                            </div>
                        </div>
                        <div class="item-price">
                            ${this.formatCurrency(item.amount || item.price, item.currency)}
                        </div>
                    </div>
                `).join('');
            }

            displayIssueDetails(orderInfo) {
                const issueSection = document.getElementById('issueDetailsSection');
                const issueDetailsList = document.getElementById('issueDetailsList');
                
                // Check if there are issue details
                const hasIssueDetails = orderInfo.issue_details && orderInfo.issue_details !== null;
                const hasIssueActions = orderInfo.issue_actions && 
                                      Array.isArray(orderInfo.issue_actions) ? 
                                      orderInfo.issue_actions.length > 0 : 
                                      orderInfo.issue_actions;
                
                const hasIssue = orderInfo.issue_raised === 1 || 
                                orderInfo.issue_details_status || 
                                orderInfo.issue_id || 
                                hasIssueDetails ||
                                hasIssueActions;

                console.log('🔍 Issue detection:', {
                    issue_details: orderInfo.issue_details,
                    issue_actions: orderInfo.issue_actions,
                    hasIssueDetails: hasIssueDetails,
                    hasIssueActions: hasIssueActions,
                    hasIssue: hasIssue
                });

                if (!hasIssue) {
                    issueSection.style.display = 'none';
                    
                    // Check if we should show "Raise Issue" button for completed orders
                    this.displayRaiseIssueButton(orderInfo);
                    return;
                }

                console.log('🔍 Displaying issue details:', {
                    issue_raised: orderInfo.issue_raised,
                    issue_details_status: orderInfo.issue_details_status,
                    'issue_details.status': orderInfo.issue_details?.status,
                    issue_id: orderInfo.issue_id,
                    issue_actions: orderInfo.issue_actions,
                    'issue_actions.action_status': orderInfo.issue_actions?.action_status,
                    issue_details: orderInfo.issue_details
                });

                // Show the issue section
                issueSection.style.display = 'block';

                // Get issue information
                const issueStatus = orderInfo.issue_details?.status || orderInfo.issue_details_status || 'OPEN';
                const issueId = orderInfo.issue_id || `ISSUE-${orderInfo.order_id}`;
                const issueActions = orderInfo.issue_actions?.action_status || orderInfo.issue_actions || null;
                const issueDetails = orderInfo.issue_details || {};

                // Create issue card
                const issueCard = `
                    <div class="issue-card ${issueStatus.toLowerCase()}">
                        <div class="issue-header">
                            <div class="issue-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Issue: ${issueId}
                            </div>
                            <div class="issue-status ${issueStatus.toLowerCase()}">
                                ${issueStatus}
                            </div>
                        </div>
                        
                        <div class="issue-info">
                            <div class="info-item">
                                <span class="info-label">Issue ID</span>
                                <span class="info-value">${issueId}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status</span>
                                <span class="info-value">${issueStatus}</span>
                            </div>
                            ${issueActions ? `
                                <div class="info-item">
                                    <span class="info-label">Latest Action</span>
                                    <span class="info-value">${issueActions}</span>
                                </div>
                            ` : ''}
                            ${this.getRefundAmountFromOrderInfo(orderInfo) ? `
                                <div class="info-item">
                                    <span class="info-label">Refund Amount</span>
                                    <span class="info-value" style="color: #10b981; font-weight: 600;">₹${this.getRefundAmountFromOrderInfo(orderInfo)}</span>
                                </div>
                            ` : ''}
                            ${issueDetails.description ? `
                                <div class="info-item">
                                    <span class="info-label">Description</span>
                                    <span class="info-value">${issueDetails.description}</span>
                                </div>
                            ` : ''}
                            ${issueDetails.category ? `
                                <div class="info-item">
                                    <span class="info-label">Category</span>
                                    <span class="info-value">${issueDetails.category}</span>
                                </div>
                            ` : ''}
                            ${issueDetails.sub_category ? `
                                <div class="info-item">
                                    <span class="info-label">Sub Category</span>
                                    <span class="info-value">${issueDetails.sub_category}</span>
                                </div>
                            ` : ''}
                            ${issueDetails.created_at ? `
                                <div class="info-item">
                                    <span class="info-label">Created At</span>
                                    <span class="info-value">${this.formatDate(issueDetails.created_at)}</span>
                                </div>
                            ` : ''}
                            ${issueDetails.updated_at ? `
                                <div class="info-item">
                                    <span class="info-label">Last Updated</span>
                                    <span class="info-value">${this.formatDate(issueDetails.updated_at)}</span>
                                </div>
                            ` : ''}
                        </div>

                        ${this.generateProposalActions(orderInfo, issueActions)}
                        ${this.generateIssueActions(issueDetails)}
                        
                        <div style="margin-top: 1rem; text-align: center;">
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button 
                                    class="issue-status-btn" 
                                    onclick="window.orderDetailsManager.showIssueStatus('${orderInfo.transaction_id}')"
                                    id="issueStatusBtn"
                                >
                                    <i class="fas fa-info-circle"></i>
                                    Issue Status
                                </button>
                                ${issueActions === 'CLOSED' || issueStatus === 'CLOSED' ? '' : `
                                    <button 
                                        class="escalation-btn" 
                                        onclick="window.orderDetailsManager.escalateIssue('${orderInfo.transaction_id}', '${orderInfo.issue_id}')"
                                        id="escalationBtn"
                                        style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;"
                                    >
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Escalation
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;

                issueDetailsList.innerHTML = issueCard;
                
                // Initialize file upload functionality if INFO_REQUESTED form is present
                if (issueActions === 'INFO_REQUESTED') {
                    // Use setTimeout to ensure DOM is fully updated
                    setTimeout(() => {
                        this.initializeFileUpload();
                    }, 100);
                }
            }

            generateProposalActions(orderInfo, issueActions) {
                // Check for different action statuses
                if (issueActions === 'RESOLUTION_PROPOSED' || issueActions === 'RESOLUTION_ACCEPTED' || issueActions === 'RESOLVED') {
                    return this.generateResolutionProposal(orderInfo, issueActions);
                } else if (issueActions === 'INFO_REQUESTED') {
                    return this.generateInfoRequestForm(orderInfo);
                }
                
                return '';
            }

            generateResolutionProposal(orderInfo, issueActions = 'RESOLUTION_PROPOSED') {
                console.log('🎯 Generating proposal actions for', issueActions, 'status');

                // Get resolution details
                const resolutions = orderInfo.issue_details?.resolutions || [];
                const hasResolutions = Array.isArray(resolutions) && resolutions.length > 0;

                console.log('🔍 All resolutions data:', resolutions);

                // Get proposal description from first resolution's descriptor
                const proposalDescription = hasResolutions && resolutions[0]?.descriptor?.short_desc ? 
                    resolutions[0].descriptor.short_desc : 
                    'The seller has proposed a resolution for this issue. Please review the details below and accept if you agree with the proposed solution.';

                console.log('📋 Proposal description from resolutions[0].descriptor.short_desc:', proposalDescription);

                // Extract refund amount from all resolutions
                let refundAmount = '';
                
                // Check all resolutions for refund amount
                for (let i = 0; i < resolutions.length; i++) {
                    const resolution = resolutions[i];
                    console.log(`🔍 Checking resolution[${i}]:`, resolution);
                    
                    // Check if resolution has tags array (not tags.list)
                    if (resolution.tags && Array.isArray(resolution.tags)) {
                        console.log(`📋 Tags array for resolution[${i}]:`, resolution.tags);
                        
                        // Look through each tag in the tags array
                        for (let j = 0; j < resolution.tags.length; j++) {
                            const tag = resolution.tags[j];
                            console.log(`📋 Tag[${j}] in resolution[${i}]:`, tag);
                            
                            // Check if this tag has a list
                            if (tag.list && Array.isArray(tag.list)) {
                                console.log(`📋 Tag[${j}] list in resolution[${i}]:`, tag.list);
                                
                                // Look for REFUND_AMOUNT in the list
                                const refundItem = tag.list.find(item => 
                                    item.descriptor?.code === 'REFUND_AMOUNT'
                                );
                                
                                if (refundItem && refundItem.value) {
                                    refundAmount = refundItem.value;
                                    console.log(`💰 Found refund amount in resolution[${i}].tags[${j}].list:`, refundAmount);
                                    break;
                                }
                            }
                        }
                        
                        if (refundAmount) break;
                    }
                    
                    // Legacy check for tags.list (in case structure is different)
                    if (resolution.tags?.list) {
                        const tagsList = resolution.tags.list;
                        console.log(`📋 Tags list for resolution[${i}]:`, tagsList);
                        
                        const refundTag = tagsList.find(tag => 
                            tag.descriptor?.code === 'REFUND_AMOUNT'
                        );
                        
                        if (refundTag && refundTag.value) {
                            refundAmount = refundTag.value;
                            console.log(`💰 Found refund amount in resolution[${i}]:`, refundAmount);
                            break;
                        }
                    }
                    
                    // Also check if the resolution itself has a refund amount
                    if (resolution.amount && !refundAmount) {
                        refundAmount = resolution.amount;
                        console.log(`💰 Found refund amount in resolution[${i}.amount]:`, refundAmount);
                    }
                }

                // If no refund amount found in tags, try to extract from description
                if (!refundAmount && hasResolutions) {
                    for (let i = 0; i < resolutions.length; i++) {
                        const resolution = resolutions[i];
                        const description = resolution.descriptor?.short_desc || resolution.description || '';
                        
                        // Look for currency patterns in description
                        const currencyMatch = description.match(/₹[\d,]+\.?\d*|INR[\s]*[\d,]+\.?\d*|\$\d+\.?\d*|\d+\.?\d*\s*(?:₹|INR|USD)/i);
                        if (currencyMatch && !refundAmount) {
                            refundAmount = currencyMatch[0];
                            console.log(`💰 Found refund amount in description:`, refundAmount);
                            break;
                        }
                    }
                }

                console.log('💰 Final refund amount found:', refundAmount);

                // Generate resolution details HTML for resolutions[1] specifically
                const resolutionDetailsHtml = hasResolutions && resolutions.length > 1 && resolutions[1] ? 
                    this.generateResolutionDisplay(resolutions[1]) : '';

                console.log('📋 Resolution[1] data:', resolutions.length > 1 ? resolutions[1] : 'Not available');

                // Determine header and title based on status
                let headerIcon = 'fas fa-handshake';
                let headerColor = '#0ea5e9';
                let title = 'Resolution Proposal Available';
                let description = proposalDescription;

                if (issueActions === 'RESOLVED') {
                    headerIcon = 'fas fa-check-circle';
                    headerColor = '#10b981';
                    title = 'Issue Resolved';
                    description = 'This issue has been resolved. If you are not satisfied with the resolution, you can escalate it for further review.';
                } else if (issueActions === 'RESOLUTION_ACCEPTED') {
                    headerIcon = 'fas fa-check-double';
                    headerColor = '#10b981';
                    title = 'Resolution Accepted';
                    description = 'You have accepted the proposed resolution. If you need further assistance, you can escalate this issue.';
                }

                return `
                    <div class="proposal-actions">
                        <div class="proposal-header">
                            <i class="${headerIcon}" style="color: ${headerColor};"></i>
                            <div class="proposal-title">${title}</div>
                        </div>
                        <div class="proposal-description">
                            ${description}
                        </div>
                        
                        ${refundAmount ? `
                            <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-money-bill-wave" style="color: #10b981; font-size: 1.2rem;"></i>
                                    <span style="font-weight: 600; color: #166534;">Refund Amount</span>
                                </div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">₹${refundAmount}</div>
                            </div>
                        ` : ''}
                        
                        ${resolutionDetailsHtml}
                        
                        ${issueActions === 'RESOLVED' || issueActions === 'RESOLUTION_ACCEPTED' ? '' : `
                            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                                <button 
                                    class="accept-proposal-btn" 
                                    onclick="window.orderDetailsManager.acceptProposal('${orderInfo.transaction_id}', '${orderInfo.issue_id}')"
                                    id="acceptProposalBtn"
                                >
                                    <i class="fas fa-check"></i>
                                    Accept Proposal
                                </button>
                                <button 
                                    class="escalation-btn" 
                                    onclick="window.orderDetailsManager.escalateIssue('${orderInfo.transaction_id}', '${orderInfo.issue_id}')"
                                    id="escalationBtn"
                                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;"
                                >
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Escalation
                                </button>
                            </div>
                        `}
                    </div>
                `;
            }

            displayRaiseIssueButton(orderInfo) {
                const raiseIssueSection = document.getElementById('raiseIssueSection');
                const raiseIssueContainer = document.getElementById('raiseIssueContainer');
                
                // Check if order status is completed
                const orderStatus = orderInfo.order_status || orderInfo.status || '';
                const isCompleted = orderStatus.toLowerCase() === 'completed';
                
                console.log('🔍 Raise issue button check:', {
                    order_status: orderStatus,
                    isCompleted: isCompleted
                });
                
                if (!isCompleted) {
                    raiseIssueSection.style.display = 'none';
                    return;
                }
                
                // Show raise issue section
                raiseIssueSection.style.display = 'block';
                
                // Generate raise issue button HTML
                const raiseIssueHtml = `
                    <div class="raise-issue-container">
                        <div class="raise-issue-description">
                            Your order has been completed. If you experienced any issues with your order, 
                            you can report them here. We'll work to resolve any problems quickly.
                        </div>
                        <button 
                            class="raise-issue-btn" 
                            onclick="window.orderDetailsManager.raiseIssue('${orderInfo.transaction_id}', '${orderInfo.order_id}')"
                            id="raiseIssueBtn"
                        >
                            <i class="fas fa-flag"></i>
                            Raise Issue
                        </button>
                    </div>
                `;
                
                raiseIssueContainer.innerHTML = raiseIssueHtml;
            }

            generateInfoRequestForm(orderInfo) {
                console.log('📋 Generating info request form for INFO_REQUESTED status');

                return `
                    <div class="info-request-section">
                        <div class="info-request-header">
                            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                            <div class="info-request-title">Additional Information Requested</div>
                        </div>
                        <div class="info-request-description">
                            The seller has requested additional information to help resolve your issue. 
                            Please provide a description and upload any relevant images or documents.
                        </div>
                        
                        <form id="infoRequestForm">
                            <div class="form-group">
                                <label class="form-label" for="issueDescription">
                                    <i class="fas fa-edit"></i> Description *
                                </label>
                                <textarea 
                                    id="issueDescription" 
                                    class="form-textarea" 
                                    placeholder="Please describe the issue in detail, including what happened, when it occurred, and any other relevant information..."
                                    required
                                ></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-images"></i> Upload Images/Documents
                                </label>
                                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        Click to upload or drag and drop files here
                                    </div>
                                    <div class="file-upload-hint">
                                        Supported formats: JPG, PNG, PDF, DOC (Max 5MB each)
                                    </div>
                                </div>
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    class="file-input" 
                                    multiple 
                                    accept="image/*,.pdf,.doc,.docx"
                                >
                                <div id="uploadedFiles" class="uploaded-files"></div>
                            </div>
                            
                            <button 
                                type="button" 
                                class="submit-info-btn" 
                                onclick="window.orderDetailsManager.submitAdditionalInfo('${orderInfo.transaction_id}')"
                                id="submitInfoBtn"
                            >
                                <i class="fas fa-paper-plane"></i>
                                Submit Information
                            </button>
                        </form>
                    </div>
                `;
            }

            generateResolutionDisplay(resolution) {
                if (!resolution) return '';

                console.log('🔍 Generating resolution display for:', resolution);

                // Extract data from resolution[1]
                const code = resolution.descriptor?.code || '';
                const shortDesc = resolution.descriptor?.short_desc || '';
                const tagsList = resolution.tags?.list || [];

                console.log('📋 Resolution details:', {
                    code: code,
                    short_desc: shortDesc,
                    tags_list: tagsList
                });

                // Generate tags list HTML
                const tagsHtml = Array.isArray(tagsList) && tagsList.length > 0 ? 
                    tagsList.map(tag => `
                        <div class="resolution-tag">
                            <div class="tag-descriptor">
                                ${tag.descriptor?.code ? `
                                    <div class="resolution-item">
                                        <span class="resolution-label">Code:</span>
                                        <span class="resolution-value">${tag.descriptor.code}</span>
                                    </div>
                                ` : ''}
                                ${tag.descriptor?.name ? `
                                    <div class="resolution-item">
                                        <span class="resolution-label">Name:</span>
                                        <span class="resolution-value">${tag.descriptor.name}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${tag.value ? `
                                <div class="resolution-item">
                                    <span class="resolution-label">Value:</span>
                                    <span class="resolution-value">${tag.value}</span>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : '';

                // Extract refund amount specifically for REFUND_AMOUNT code
                let refundAmount = '';
                
                // Check if tags is an array (new structure)
                if (Array.isArray(resolution.tags)) {
                    for (const tag of resolution.tags) {
                        if (tag.list && Array.isArray(tag.list)) {
                            const refundItem = tag.list.find(item => 
                                item.descriptor?.code === 'REFUND_AMOUNT'
                            );
                            if (refundItem && refundItem.value) {
                                refundAmount = refundItem.value;
                                break;
                            }
                        }
                    }
                } else if (resolution.tags?.list) {
                    // Legacy structure
                    refundAmount = tagsList.find(tag => 
                        tag.descriptor?.code === 'REFUND_AMOUNT'
                    )?.value;
                }

                return `
                    <div class="resolution-details">
                        ${code ? `
                            <div class="resolution-item">
                                <span class="resolution-label">Resolution Code:</span>
                                <span class="resolution-value">${code}</span>
                            </div>
                        ` : ''}
                        
                        ${shortDesc ? `
                            <div class="resolution-item">
                                <span class="resolution-label">Description:</span>
                                <span class="resolution-value">${shortDesc}</span>
                            </div>
                        ` : ''}
                        
                        ${refundAmount ? `
                            <div class="resolution-item">
                                <span class="resolution-label">Refund Amount:</span>
                                <span class="resolution-value" style="color: #10b981; font-weight: 600;">${refundAmount}</span>
                            </div>
                        ` : ''}
                        
                        ${tagsHtml ? `
                            <div class="resolution-item">
                                <span class="resolution-label">Tags:</span>
                                <div class="resolution-tags-container">
                                    ${tagsHtml}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            generateIssueActions(issueDetails) {
                if (!issueDetails.actions && !issueDetails.timeline) {
                    return '';
                }

                const actions = issueDetails.actions || issueDetails.timeline || [];
                if (!Array.isArray(actions) || actions.length === 0) {
                    return '';
                }

                // Generate progress bar timeline
                const timelineHtml = this.generateProgressTimeline(actions);

                // Generate issue close button only if issue status is RESOLVED
                const issueStatus = this.orderData?.issue_details_status || this.orderData?.issue_details?.status || 'OPEN';
                const closeButtonHtml = issueStatus.toUpperCase() === 'RESOLVED' ? this.generateIssueCloseButton() : '';

                console.log('🔍 Issue status check for close button:', {
                    issue_details_status: this.orderData?.issue_details_status,
                    issue_details_status_nested: this.orderData?.issue_details?.status,
                    final_status: issueStatus,
                    show_close_button: issueStatus.toUpperCase() === 'RESOLVED'
                });

                return `
                    ${timelineHtml}
                    ${closeButtonHtml}
                `;
            }

            generateProgressTimeline(actions) {
                // Define standard ONDC issue workflow steps
                const standardSteps = [
                    { code: 'ISSUE_RAISED', label: 'Issue Raised', icon: '🚨' },
                    { code: 'INFO_REQUESTED', label: 'Info Requested', icon: '❓' },
                    { code: 'INFO_PROVIDED', label: 'Info Provided', icon: '📋' },
                    { code: 'RESOLUTION_PROPOSED', label: 'Resolution Proposed', icon: '💡' },
                    { code: 'RESOLUTION_ACCEPTED', label: 'Resolution Accepted', icon: '✅' },
                    { code: 'ISSUE_CLOSED', label: 'Issue Closed', icon: '🔒' }
                ];

                // Get action codes from the actions array
                const actionCodes = actions.map(action => 
                    action.descriptor?.code || action.action_type || action.type
                ).filter(Boolean);

                // Check if issue is closed - if so, mark all steps as completed
                const issueStatus = this.orderData?.issue_details_status || this.orderData?.issue_details?.status || 'OPEN';
                const isIssueClosed = issueStatus.toLowerCase() === 'closed';
                
                console.log('🔍 Timeline generation:', {
                    actionCodes: actionCodes,
                    issueStatus: issueStatus,
                    isIssueClosed: isIssueClosed
                });

                // If issue is closed, ensure ISSUE_CLOSED is in the action codes
                if (isIssueClosed && !actionCodes.includes('ISSUE_CLOSED')) {
                    actionCodes.push('ISSUE_CLOSED');
                    console.log('🔒 Added ISSUE_CLOSED to action codes since status is CLOSED');
                }

                // Determine which steps are completed, current, or pending
                const stepsWithStatus = standardSteps.map((step, index) => {
                    let isCompleted = actionCodes.includes(step.code);
                    const actionIndex = actionCodes.indexOf(step.code);
                    const actionData = actionIndex >= 0 ? actions[actionIndex] : null;
                    
                    // If issue is closed, mark all steps up to and including ISSUE_CLOSED as completed
                    if (isIssueClosed) {
                        const closedStepIndex = standardSteps.findIndex(s => s.code === 'ISSUE_CLOSED');
                        if (index <= closedStepIndex) {
                            isCompleted = true;
                        }
                    } else {
                        // For non-closed issues, use sequential completion logic
                        // Find the highest step index that has an action code
                        const maxCompletedIndex = Math.max(...actionCodes.map(code => 
                            standardSteps.findIndex(s => s.code === code)
                        ).filter(idx => idx !== -1));
                        
                        // Mark all steps up to the highest completed step as completed
                        if (index <= maxCompletedIndex) {
                            isCompleted = true;
                        }
                    }
                    
                    // Find the current step (last completed step) - but not if issue is closed
                    let isCurrent = false;
                    if (!isIssueClosed) {
                        const lastCompletedIndex = standardSteps.findIndex((s, i) => 
                            i < standardSteps.length - 1 && 
                            actionCodes.includes(s.code) && 
                            !actionCodes.includes(standardSteps[i + 1].code)
                        );
                        isCurrent = index === lastCompletedIndex + 1 && !isCompleted;
                    }
                    
                    return {
                        ...step,
                        isCompleted,
                        isCurrent,
                        isPending: !isCompleted && !isCurrent,
                        actionData,
                        stepNumber: index + 1
                    };
                });

                // Calculate progress percentage
                const completedSteps = stepsWithStatus.filter(step => step.isCompleted).length;
                const progressPercentage = (completedSteps / standardSteps.length) * 100;
                
                console.log('📊 Timeline progress calculation:', {
                    totalSteps: standardSteps.length,
                    completedSteps: completedSteps,
                    progressPercentage: Math.round(progressPercentage),
                    stepsWithStatus: stepsWithStatus.map(s => ({ 
                        code: s.code, 
                        label: s.label, 
                        isCompleted: s.isCompleted, 
                        isCurrent: s.isCurrent 
                    }))
                });

                // Generate timeline HTML
                const stepsHtml = stepsWithStatus.map(step => {
                    const statusClass = step.isCompleted ? 'completed' : 
                                      step.isCurrent ? 'current' : 'pending';
                    
                    const stepDate = step.actionData ? 
                        this.formatDate(step.actionData.created_at || step.actionData.timestamp || step.actionData.date) : '';

                    return `
                        <div class="timeline-step">
                            <div class="step-circle ${statusClass}">
                                ${step.isCompleted ? '✓' : step.isCurrent ? step.stepNumber : step.stepNumber}
                            </div>
                            <div class="step-label ${statusClass}">
                                ${step.label}
                            </div>
                            ${stepDate ? `<div class="step-date">${stepDate}</div>` : ''}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="issue-timeline-progress">
                        <div class="timeline-header">
                            <div class="timeline-title">
                                <i class="fas fa-route"></i> Issue Progress Timeline
                            </div>
                            <div class="timeline-progress">
                                ${completedSteps}/${standardSteps.length} Steps Completed (${Math.round(progressPercentage)}%)
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                        </div>
                        
                        <div class="timeline-steps">
                            <div class="timeline-connector">
                                <div class="timeline-connector-fill" style="width: ${Math.max(0, (completedSteps - 1) / (standardSteps.length - 1) * 100)}%"></div>
                            </div>
                            ${stepsHtml}
                        </div>
                    </div>
                `;
            }

            generateIssueCloseButton() {
                return `
                    <div class="issue-close-container">
                        <div class="issue-close-header">
                            <i class="fas fa-times-circle" style="color: #dc2626;"></i>
                            <div class="issue-close-title">Close Issue</div>
                        </div>
                        <div class="issue-close-description">
                            If your issue has been resolved to your satisfaction, you can close this issue. 
                            This action will mark the issue as completed and notify the seller.
                        </div>
                        <button 
                            class="close-issue-btn" 
                            onclick="window.orderDetailsManager.closeIssue('${this.transactionId}')"
                            id="closeIssueBtn"
                        >
                            <i class="fas fa-times-circle"></i>
                            Close Issue
                        </button>
                    </div>
                `;
            }

            formatCurrency(amount, currency = 'INR') {
                if (!amount) return '-';
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: currency
                }).format(amount);
            }

            formatDate(dateString) {
                if (!dateString) return '-';
                return new Date(dateString).toLocaleString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            getRefundAmountFromOrderInfo(orderInfo) {
                // Extract refund amount from resolutions
                const resolutions = orderInfo.issue_details?.resolutions || [];
                
                for (let i = 0; i < resolutions.length; i++) {
                    const resolution = resolutions[i];
                    
                    // Check if resolution has tags array
                    if (resolution.tags && Array.isArray(resolution.tags)) {
                        for (const tag of resolution.tags) {
                            if (tag.list && Array.isArray(tag.list)) {
                                const refundItem = tag.list.find(item => 
                                    item.descriptor?.code === 'REFUND_AMOUNT'
                                );
                                if (refundItem && refundItem.value) {
                                    return refundItem.value;
                                }
                            }
                        }
                    }
                    
                    // Legacy check for tags.list
                    if (resolution.tags?.list) {
                        const refundTag = resolution.tags.list.find(tag => 
                            tag.descriptor?.code === 'REFUND_AMOUNT'
                        );
                        if (refundTag && refundTag.value) {
                            return refundTag.value;
                        }
                    }
                }
                
                return null;
            }

            async showIssueStatus(transactionId) {
                console.log('📊 Showing issue status for transaction:', transactionId);
                
                const button = document.getElementById('issueStatusBtn');
                if (!button) {
                    console.error('❌ Issue Status button not found!');
                    return;
                }

                // Disable button and show loading state
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div> Loading...';

                try {
                    // Prepare API request
                    const apiUrl = 'http://127.0.0.1:8000/issues/issue_status';
                    const requestData = {
                        transaction_id: transactionId
                    };

                    console.log('📡 Calling issue status API:', apiUrl);
                    console.log('📦 Request data:', requestData);

                    let response = null;
                    let successMethod = null;
                    let lastError = null;

                    // Method 1: Direct API call
                    try {
                        console.log('🔄 Method 1: Trying direct API call...');
                        console.log('📡 API URL:', apiUrl);
                        console.log('📦 Request Data:', requestData);
                        console.log('🌐 Current origin:', window.location.origin);
                        console.log('🌐 Current protocol:', window.location.protocol);
                        
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            mode: 'cors',
                            credentials: 'omit',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        console.log('📡 Response status:', response.status);
                        console.log('📡 Response ok:', response.ok);
                        console.log('📡 Response headers:', [...response.headers.entries()]);

                        if (response.ok) {
                            successMethod = 'Direct API';
                            console.log('✅ Direct API successful for issue status');
                        } else {
                            console.log(`❌ Direct API failed with status: ${response.status}`);
                            const errorText = await response.text();
                            console.log('❌ Error response:', errorText);
                        }
                    } catch (error) {
                        lastError = error;
                        console.log('❌ Direct API failed for issue status:', error.message);
                        console.log('❌ Error details:', error);
                    }

                    // Method 2: Try with CORS headers if direct failed
                    if (!response || !response.ok) {
                        try {
                            console.log('🔄 Method 2: Trying with CORS headers...');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.ok) {
                                successMethod = 'CORS API';
                                console.log('✅ CORS API successful for issue status');
                            } else {
                                console.log(`❌ CORS API failed with status: ${response.status}`);
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ CORS API failed for issue status:', error.message);
                        }
                    }

                    // Method 3: Try with different headers if previous methods failed
                    if (!response || !response.ok) {
                        try {
                            console.log('🔄 Method 3: Trying with different headers...');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json',
                                    'Cache-Control': 'no-cache'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.ok) {
                                successMethod = 'Direct API (Alternative Headers)';
                                console.log('✅ Alternative headers successful for issue status');
                            } else {
                                console.log(`❌ Alternative headers failed with status: ${response.status}`);
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ Alternative headers failed for issue status:', error.message);
                        }
                    }

                    if (!response || !response.ok) {
                        const errorMessage = lastError ? lastError.message : `HTTP error! status: ${response?.status || 'Network Error'}`;
                        console.error('❌ All methods failed. Last error:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('✅ Issue status loaded successfully:', result);

                    // Display issue status in popup
                    this.showIssueStatusPopup(result, transactionId, successMethod);

                } catch (error) {
                    console.error('❌ Failed to load issue status:', error);
                    
                    // Show error message
                    this.showErrorMessage('Failed to Load Issue Status', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Issue Status Failed</h3>
                            <p style="margin-bottom: 1rem;">Unable to load issue status at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Error:</strong> ${error.message}</div>
                                <div><strong>Protocol:</strong> ${window.location.protocol}</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                Please try again or contact support if the problem persists.
                            </p>
                        </div>
                    `);

                } finally {
                    // Restore button state
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }

            showIssueStatusPopup(statusData, transactionId, method) {
                console.log('📊 Displaying issue status popup:', statusData);

                // Remove existing modal if any
                const existingModal = document.getElementById('issueStatusModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'issueStatusModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                `;

                // Extract issue data from the new API response format
                const issueData = statusData.data || statusData;
                const statusItems = [];

                // Add core issue information
                if (issueData.id) {
                    statusItems.push({
                        label: 'Issue ID',
                        value: issueData.id,
                        style: 'font-family: monospace; color: #6b7280;'
                    });
                }

                if (issueData.status) {
                    const statusColor = issueData.status === 'CLOSED' ? '#10b981' : 
                                      issueData.status === 'PROCESSING' ? '#f59e0b' : 
                                      issueData.status === 'OPEN' ? '#3b82f6' : '#6b7280';
                    statusItems.push({
                        label: 'Issue Status',
                        value: issueData.status,
                        style: `color: ${statusColor}; font-weight: 600;`
                    });
                }

                if (issueData.updated_at) {
                    statusItems.push({
                        label: 'Last Updated',
                        value: this.formatDate(issueData.updated_at)
                    });
                }

                if (issueData.created_at) {
                    statusItems.push({
                        label: 'Created At',
                        value: this.formatDate(issueData.created_at)
                    });
                }

                if (issueData.level) {
                    statusItems.push({
                        label: 'Level',
                        value: issueData.level
                    });
                }

                // Add descriptor information if available
                if (issueData.descriptor) {
                    if (issueData.descriptor.short_desc) {
                        statusItems.push({
                            label: 'Description',
                            value: issueData.descriptor.short_desc
                        });
                    }
                    if (issueData.descriptor.long_desc) {
                        statusItems.push({
                            label: 'Details',
                            value: issueData.descriptor.long_desc
                        });
                    }
                }

                // Add expected times if available
                if (issueData.expected_response_time?.duration) {
                    statusItems.push({
                        label: 'Expected Response Time',
                        value: issueData.expected_response_time.duration
                    });
                }

                if (issueData.expected_resolution_time?.duration) {
                    statusItems.push({
                        label: 'Expected Resolution Time',
                        value: issueData.expected_resolution_time.duration
                    });
                }

                // Add last action if available
                if (issueData.last_action_id) {
                    statusItems.push({
                        label: 'Last Action ID',
                        value: issueData.last_action_id,
                        style: 'font-family: monospace; color: #6b7280;'
                    });
                }

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                            Issue Status Details
                        </h2>
                        <button onclick="document.getElementById('issueStatusModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Transaction ID:</div>
                        <div style="color: #6b7280; font-family: monospace;">${transactionId}</div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        ${statusItems.map(item => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-weight: 600; color: #64748b;">${item.label}</span>
                                <span style="color: #1e293b; ${item.style || ''}">${item.value}</span>
                            </div>
                        `).join('')}
                    </div>

                    ${statusData.note ? `
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">Note:</div>
                            <div style="color: #92400e; font-size: 0.9rem;">${statusData.note}</div>
                        </div>
                    ` : ''}


                    <div style="text-align: center;">
                        <button onclick="document.getElementById('issueStatusModal').remove()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            async acceptProposal(transactionId, issueId) {
                console.log('🤝 Accepting proposal for:', { transactionId, issueId });
                
                const button = document.getElementById('acceptProposalBtn');
                if (!button) {
                    console.error('❌ Accept Proposal button not found!');
                    return;
                }
                
                console.log('✅ Accept Proposal button found:', button);

                // Disable button and show loading state
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div> Accepting...';

                try {
                    // Prepare API request
                    const apiUrl = 'https://neo-server.rozana.in/issues/accept-proposal';
                    const requestData = {
                        transaction_id: transactionId
                    };

                    console.log('📡 Sending accept proposal request:', requestData);
                    console.log('🌐 Current origin:', window.location.origin);
                    console.log('🌐 Current protocol:', window.location.protocol);
                    console.log('🔗 API URL:', apiUrl);
                    console.log('📦 Request payload:', JSON.stringify(requestData, null, 2));

                    // Direct call to external API (primary method)
                    let response = null;
                    let successMethod = null;
                    let lastError = null;

                    // Method 1: Direct external API call with no-cors (works from file://)
                    try {
                        console.log('🔄 Direct call to external API for accept proposal...');
                        console.log('📡 Calling:', apiUrl);
                        console.log('📦 Payload:', JSON.stringify(requestData, null, 2));
                        
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        if (response.ok) {
                            successMethod = 'Direct External API';
                            console.log('✅ External API request successful');
                            console.log('📡 Request details:', {
                                url: apiUrl,
                                method: 'POST',
                                payload: requestData,
                                status: response.status,
                                statusText: response.statusText
                            });
                        } else {
                            console.log(`❌ External API failed with status: ${response.status} ${response.statusText}`);
                            // Try to get error details from response
                            try {
                                const errorText = await response.text();
                                console.log('❌ API Error Response:', errorText);
                                try {
                                    const errorJson = JSON.parse(errorText);
                                    console.log('❌ API Error Details:', errorJson);
                                } catch (e) {
                                    console.log('❌ Error response is not JSON');
                                }
                            } catch (e) {
                                console.log('❌ Could not read error response');
                            }
                        }
                    } catch (error) {
                        lastError = error;
                        console.log('❌ Direct external API call failed:', error.message);
                    }

                    // Skip all fallback methods - direct external API call only
                    if (false) {
                        try {
                            console.log('🔄 Method 2: Trying with CORS headers for accept proposal...');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.ok) {
                                successMethod = 'CORS API';
                                console.log('✅ CORS API successful for accept proposal');
                            } else {
                                console.log(`❌ CORS API failed with status: ${response.status} ${response.statusText}`);
                                // Try to get error details from response
                                try {
                                    const errorText = await response.text();
                                    console.log('❌ CORS API Error Response:', errorText);
                                    try {
                                        const errorJson = JSON.parse(errorText);
                                        console.log('❌ CORS API Error Details:', errorJson);
                                    } catch (e) {
                                        console.log('❌ CORS Error response is not JSON');
                                    }
                                } catch (e) {
                                    console.log('❌ Could not read CORS error response');
                                }
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ CORS API failed for accept proposal:', error.message);
                        }
                    }

                    // Method 3: Try POST proxy for file protocol (actual Laravel API call)
                    if ((!response || !response.ok) && (window.location.protocol === 'file:' || window.location.origin === 'null')) {
                        try {
                            console.log('🔄 Method 3: Trying POST proxy for file:// protocol...');
                            console.log('⚠️ File protocol detected, using POST proxy to reach Laravel API');
                            
                            // Use local Laravel API instead of external API
                            const localApiUrl = 'http://127.0.0.1:8000/issues/accept-proposal';
                            const proxyUrl = `./post-proxy.php?url=${encodeURIComponent(localApiUrl)}`;
                            
                            console.log('📡 POST Proxy URL:', proxyUrl);
                            console.log('📡 Target Laravel API:', localApiUrl);
                            console.log('📦 Request data:', requestData);
                            
                            response = await fetch(proxyUrl, {
                                method: 'POST',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.ok) {
                                successMethod = 'POST Proxy (Laravel API)';
                                console.log('✅ POST Proxy successful for accept proposal');
                            } else {
                                console.log(`❌ POST Proxy failed with status: ${response.status}`);
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ POST Proxy failed for accept proposal:', error.message);
                            console.log('⚠️ File protocol cannot access local PHP files due to browser security');
                        }
                    }

                    // Method 4: Show helpful error message for file protocol
                    if ((!response || !response.ok) && (window.location.protocol === 'file:' || window.location.origin === 'null')) {
                        try {
                            console.log('🔄 Method 4: Trying external API fallback for file:// protocol...');
                            console.log('⚠️ Using external API as fallback (cannot verify success)');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.type === 'opaque') {
                                successMethod = 'External API (No-CORS Fallback)';
                                console.log('✅ External API request sent (opaque response)');
                                console.log('⚠️ Note: Cannot verify if request succeeded due to no-cors mode');
                                // Create a mock response since we can't read opaque responses
                                response = { 
                                    ok: true, 
                                    json: () => Promise.resolve({ 
                                        success: true, 
                                        message: 'Request sent to external API (success cannot be verified)',
                                        data: [],
                                        note: 'This is a fallback mode - actual success depends on server processing'
                                    }) 
                                };
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ External API fallback failed:', error.message);
                        }
                    }

                    if (!response || !response.ok) {
                        const errorMessage = lastError ? lastError.message : `HTTP error! status: ${response?.status || 'Network Error'}`;
                        console.error('❌ All methods failed. Last error:', errorMessage);
                        
                        // Provide specific error details for CORS issues
                        let detailedError = errorMessage;
                        if (lastError && lastError.message.includes('CORS')) {
                            detailedError = 'Network Connection Error';
                        }
                        
                        throw new Error(detailedError);
                    }

                    const result = await response.json();
                    console.log('✅ Proposal accepted successfully:', result);

                    // Show success message (same pattern as upload-additional-info)
                    this.showSuccessMessage('Proposal Accepted Successfully!', `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                            <h3 style="color: #10b981; margin-bottom: 1rem;">Proposal Accepted Successfully!</h3>
                            <p style="margin-bottom: 1rem;">Your acceptance has been recorded and the seller will be notified.</p>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Response:</strong> ${result.message || 'Success'}</div>
                                <div><strong>Method:</strong> ${successMethod}</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                The issue status will be updated shortly.
                            </p>
                        </div>
                    `);

                    // Update button to show accepted state
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Proposal Accepted';
                    button.style.background = '#10b981';
                    button.disabled = true;

                    // Optionally reload the page data after a delay
                    setTimeout(() => {
                        console.log('🔄 Reloading order details after proposal acceptance...');
                        this.loadOrderDetails();
                    }, 2000);

                } catch (error) {
                    console.error('❌ Failed to accept proposal:', error);
                    
                    // Determine error type and provide specific guidance
                    let errorType = 'Unknown Error';
                    let troubleshootingTips = '';
                    
                    if (error.message.includes('Network Error') || error.message.includes('Failed to fetch')) {
                        errorType = 'Network Connection Error';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>Troubleshooting Tips:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li>Check your internet connection</li>
                                    <li>Try refreshing the page</li>
                                    <li>Disable any ad blockers or VPN</li>
                                    <li>Check if the server is accessible: <a href="https://neo-server.rozana.in" target="_blank" style="color: #3b82f6;">neo-server.rozana.in</a></li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('CORS') || window.location.protocol === 'file:') {
                        errorType = 'File Protocol Issue';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>File Protocol Detected - Use Web Server Instead:</strong>
                                <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><strong>Option 1 (Recommended):</strong> Double-click <code>start-local-server.bat</code> in the project folder</li>
                                    <li><strong>Option 2:</strong> Use XAMPP - Access via <code>http://localhost/rozana_ondc/order-details.html</code></li>
                                    <li><strong>Option 3:</strong> Use Python - Run <code>python -m http.server 8080</code> in project folder</li>
                                    <li><strong>Option 4:</strong> Use Node.js - Run <code>npx http-server -p 8080</code> in project folder</li>
                                </ol>
                                <div style="background: #fef3c7; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                                    <strong>Why this happens:</strong> Browsers block file:// protocol from accessing local PHP files for security reasons.
                                </div>
                            </div>
                        `;
                    } else if (error.message.includes('404')) {
                        errorType = 'API Endpoint Not Found';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>Troubleshooting Tips:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li>Verify the API endpoint URL is correct</li>
                                    <li>Check if the API service is running</li>
                                    <li>Contact the API administrator</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Show detailed error message
                    this.showErrorMessage('Failed to Accept Proposal', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Acceptance Failed</h3>
                            <p style="margin-bottom: 1rem;">Unable to accept the proposal at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Error Type:</strong> ${errorType}</div>
                                <div><strong>Error Details:</strong> ${error.message}</div>
                                <div><strong>Current Protocol:</strong> ${window.location.protocol}</div>
                                <div><strong>Current Origin:</strong> ${window.location.origin}</div>
                            </div>
                            ${troubleshootingTips}
                            <p style="font-size: 0.9rem; color: #6b7280; margin-top: 1rem;">
                                If the issue persists, please contact support with the above details.
                            </p>
                        </div>
                    `);

                    // Restore button state
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }

            showSuccessMessage(title, content) {
                this.showModal(title, content, 'success');
            }

            showErrorMessage(title, content) {
                this.showModal(title, content, 'error');
            }

            async raiseIssue(transactionId, orderId) {
                console.log('🚨 Opening raise issue form for:', { transactionId, orderId });
                
                // Open the raise issue form modal
                this.showRaiseIssueForm(transactionId, orderId);
            }

            async showRaiseIssueForm(transactionId, orderId) {
                console.log('📝 Showing raise issue form modal');
                
                // Remove existing modal if any
                const existingModal = document.getElementById('raiseIssueModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Get order items from current order data
                const orderItems = this.currentOrderData?.order_details || [];

                // Load issue categories from API only
                let categories = [];
                
                try {
                    console.log('🔄 Loading categories from API...');
                    const response = await fetch('https://neo-server.rozana.in/issues/categories', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('📡 API Response status:', response.status);
                    console.log('📡 API Response ok:', response.ok);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('📡 API Response data:', data);
                        
                        if (data.success && data.data && Array.isArray(data.data)) {
                            categories = data.data;
                            console.log('✅ Loaded categories from API:', categories);
                        } else {
                            console.error('❌ Invalid API response format:', data);
                            throw new Error('Invalid API response format');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('❌ API request failed:', response.status, errorText);
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('❌ Failed to load categories from API:', error);
                    console.log('⚠️ Error type:', error.name);
                    console.log('⚠️ Error message:', error.message);
                    
                    // Show error message in UI
                    alert('Failed to load issue categories. Please check if the server is accessible.');
                    return; // Exit early if categories can't be loaded
                }

                // Log the categories being used
                console.log('🎯 Categories being used in form:', categories);
                console.log('🎯 Number of categories:', categories.length);

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'raiseIssueModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    overflow-y: auto;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                    margin: 20px;
                `;

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-flag" style="color: #f59e0b;"></i>
                            Raise Issue
                        </h2>
                        <button onclick="document.getElementById('raiseIssueModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
                    </div>

                    <form id="raiseIssueForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Choose Items Section -->
                        <div>
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Choose Items that had a problem *
                            </label>
                            <div id="issueItemsList" style="display: flex; flex-direction: column; gap: 1rem;">
                                ${orderItems.map((item, index) => `
                                    <div class="issue-item-checkbox" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f8fafc; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s ease;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; flex: 1; cursor: pointer;">
                                            <input 
                                                type="checkbox" 
                                                name="issue_items" 
                                                value="${item.item_id || item.id}" 
                                                data-title="${(item.title || item.name || 'Unknown Item').replace(/'/g, "&apos;")}" 
                                                data-price="${item.amount || item.price || 0}"
                                                style="width: 18px; height: 18px; cursor: pointer;"
                                            >
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #1e293b;">${item.title || item.name || 'Unknown Item'}</div>
                                                <div style="font-size: 0.875rem; color: #64748b;">QTY: ${item.quantity || 0} | ₹${item.amount || item.price || 0}</div>
                                            </div>
                                        </label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <label style="font-size: 0.875rem; color: #64748b;">QTY:</label>
                                            <input 
                                                type="number" 
                                                name="item_quantity_${item.item_id || item.id}" 
                                                value="1" 
                                                min="1" 
                                                max="${item.quantity || 1}" 
                                                disabled
                                                style="width: 60px; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 6px; text-align: center; background: white;"
                                            >
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Select Issue Category -->
                        <div>
                            <label for="category" style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Select Issue Category
                            </label>
                            <select 
                                id="category" 
                                name="category" 
                                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; color: #374151;"
                                onchange="console.log('🔄 Category changed to:', this.value); window.orderDetailsManager.loadSubcategories(this.value);"
                            >
                                ${categories.length > 0 ? categories.map((category, index) => `
                                    <option value="${category}" ${index === 0 ? 'selected' : ''}>${category}</option>
                                `).join('') : '<option value="Error">No categories available</option>'}
                            </select>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                                ${categories.length > 0 ? `Loaded ${categories.length} categories` : 'Failed to load categories'}
                            </div>
                        </div>

                        <!-- Select Issue Subcategory -->
                        <div>
                            <label for="sub_category" style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Select Issue Subcategory
                            </label>
                            <select 
                                id="sub_category" 
                                name="sub_category" 
                                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; color: #374151;"
                            >
                                <option value="Loading...">Loading subcategories...</option>
                            </select>
                        </div>

                        <!-- Short Description -->
                        <div>
                            <label for="short_description" style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Short Description *
                            </label>
                            <input 
                                type="text" 
                                id="short_description" 
                                name="short_description" 
                                placeholder="Enter short description" 
                                required
                                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                            >
                        </div>

                        <!-- Long Description -->
                        <div>
                            <label for="long_description" style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Long Description *
                            </label>
                            <textarea 
                                id="long_description" 
                                name="long_description" 
                                placeholder="Enter long description" 
                                required
                                rows="4"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; resize: vertical;"
                            ></textarea>
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="email" style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Email
                            </label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                value="pallavi@wemotiveforge.com" 
                                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: #f8fafc;"
                            >
                        </div>

                        <!-- Images Upload -->
                        <div>
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                                Images (Maximum 4)
                            </label>
                            <div class="file-upload-area" onclick="document.getElementById('issueFileInput').click()" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; background: #f9fafb; transition: all 0.2s ease; cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6b7280; margin-bottom: 0.5rem;"></i>
                                <div style="color: #374151; font-size: 0.9rem; margin-bottom: 0.5rem;">Click to upload or drag and drop files here</div>
                                <div style="color: #6b7280; font-size: 0.8rem;">Supported formats: JPG, PNG, PDF, DOC (Max 5MB each)</div>
                            </div>
                            <input 
                                type="file" 
                                id="issueFileInput" 
                                multiple 
                                accept="image/*,.pdf,.doc,.docx"
                                style="display: none;"
                            >
                            <div id="issueUploadedFiles" class="uploaded-files" style="margin-top: 1rem;"></div>
                        </div>

                        <!-- Submit Button -->
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button 
                                type="button" 
                                onclick="document.getElementById('raiseIssueModal').remove()" 
                                style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit" 
                                id="submitRaiseIssueBtn"
                                style="padding: 0.75rem 1.5rem; border: none; border-radius: 6px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;"
                            >
                                <i class="fas fa-flag"></i>
                                Raise Issue
                            </button>
                        </div>
                    </form>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Initialize form functionality
                this.initializeRaiseIssueForm(transactionId, orderId);

                // Load initial subcategories for the first category (only if categories loaded successfully)
                if (categories.length > 0) {
                    this.loadSubcategories(categories[0]);
                } else {
                    // Set error state for subcategory dropdown
                    const subcategorySelect = document.getElementById('sub_category');
                    if (subcategorySelect) {
                        subcategorySelect.innerHTML = '<option value="Error">No categories available</option>';
                        subcategorySelect.disabled = true;
                    }
                }

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            async loadSubcategories(category) {
                console.log('📋 Loading subcategories for category:', category);
                
                const subcategorySelect = document.getElementById('sub_category');
                if (!subcategorySelect) {
                    console.error('❌ Subcategory select element not found!');
                    return;
                }

                // Show loading state
                subcategorySelect.innerHTML = '<option value="Loading...">Loading subcategories...</option>';
                subcategorySelect.disabled = true;

                try {
                    console.log('🌐 Making API request to:', `https://neo-server.rozana.in/issues/subcategories?category=${encodeURIComponent(category)}`);
                    
                    const response = await fetch(`https://neo-server.rozana.in/issues/subcategories?category=${encodeURIComponent(category)}`);
                    
                    console.log('📡 Response status:', response.status);
                    console.log('📡 Response ok:', response.ok);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('📡 Raw API response:', data);
                        
                        if (data.success && data.data && Array.isArray(data.data)) {
                            const subcategories = data.data;
                            console.log('✅ Loaded subcategories:', subcategories);
                            console.log('📊 Number of subcategories:', subcategories.length);
                            
                            // Clear and populate subcategory dropdown
                            subcategorySelect.innerHTML = '';
                            
                            subcategories.forEach((subcategory, index) => {
                                console.log(`📝 Adding subcategory ${index + 1}:`, subcategory);
                                
                                const option = document.createElement('option');
                                option.value = subcategory.subcategory;
                                option.textContent = subcategory.subcategory;
                                
                                // Select first option
                                if (index === 0) {
                                    option.selected = true;
                                    console.log('🎯 Selected subcategory:', subcategory.subcategory);
                                }
                                
                                subcategorySelect.appendChild(option);
                            });
                            
                            subcategorySelect.disabled = false;
                            console.log('✅ Subcategory dropdown populated successfully');
                        } else {
                            console.error('❌ Invalid response format:', data);
                            // Keep loading state if response is invalid
                            subcategorySelect.innerHTML = '<option value="Error">Error loading subcategories</option>';
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('❌ HTTP Error:', response.status, response.statusText, errorText);
                        // Show error state
                        subcategorySelect.innerHTML = '<option value="Error">Error loading subcategories</option>';
                    }
                } catch (error) {
                    console.log('⚠️ Failed to load subcategories from API:', error);
                    console.log('⚠️ Error type:', error.name);
                    console.log('⚠️ Error message:', error.message);
                    
                    // Show error state
                    subcategorySelect.innerHTML = '<option value="Error">Error loading subcategories</option>';
                }
            }


            initializeRaiseIssueForm(transactionId, orderId) {
                console.log('🔧 Initializing raise issue form');

                // Initialize file upload for issue form
                const fileInput = document.getElementById('issueFileInput');
                const uploadedFilesContainer = document.getElementById('issueUploadedFiles');
                const uploadArea = document.querySelector('#raiseIssueModal .file-upload-area');
                
                if (!this.issueFiles) {
                    this.issueFiles = [];
                }

                // File input change handler
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        console.log('📁 Issue files selected:', e.target.files.length);
                        this.handleIssueFileSelection(e.target.files);
                    });
                }

                // Drag and drop handlers
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.style.borderColor = '#3b82f6';
                        uploadArea.style.background = '#eff6ff';
                    });

                    uploadArea.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        uploadArea.style.borderColor = '#d1d5db';
                        uploadArea.style.background = '#f9fafb';
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.style.borderColor = '#d1d5db';
                        uploadArea.style.background = '#f9fafb';
                        console.log('📁 Issue files dropped:', e.dataTransfer.files.length);
                        this.handleIssueFileSelection(e.dataTransfer.files);
                    });
                }

                // Item checkbox handler
                const checkboxes = document.querySelectorAll('input[name="issue_items"]');
                checkboxes.forEach(checkbox => {
                    const itemId = checkbox.value;
                    const quantityInput = document.querySelector(`input[name="item_quantity_${itemId}"]`);
                    
                    checkbox.addEventListener('change', (e) => {
                        if (quantityInput) {
                            quantityInput.disabled = !e.target.checked;
                            if (e.target.checked) {
                                e.target.closest('.issue-item-checkbox').style.borderColor = '#f59e0b';
                                e.target.closest('.issue-item-checkbox').style.background = '#fffbeb';
                            } else {
                                e.target.closest('.issue-item-checkbox').style.borderColor = 'transparent';
                                e.target.closest('.issue-item-checkbox').style.background = '#f8fafc';
                            }
                        }
                    });
                });

                // Form submit handler
                const form = document.getElementById('raiseIssueForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.submitRaiseIssueForm(transactionId, orderId);
                    });
                }
            }

            handleIssueFileSelection(files) {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const maxFiles = 4;
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

                Array.from(files).forEach(file => {
                    // Check max files limit
                    if (this.issueFiles.length >= maxFiles) {
                        alert(`Maximum ${maxFiles} files allowed.`);
                        return;
                    }

                    // Validate file size
                    if (file.size > maxSize) {
                        alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                        return;
                    }

                    // Validate file type
                    if (!allowedTypes.includes(file.type)) {
                        alert(`File "${file.name}" is not supported. Please upload JPG, PNG, PDF, or DOC files.`);
                        return;
                    }

                    // Check if file already exists
                    if (this.issueFiles.some(f => f.name === file.name && f.size === file.size)) {
                        alert(`File "${file.name}" is already selected.`);
                        return;
                    }

                    // Add file to issue files
                    this.issueFiles.push(file);
                    console.log('✅ Issue file added:', file.name, '| Total files:', this.issueFiles.length);
                });

                this.updateIssueFilesList();
            }

            updateIssueFilesList() {
                const container = document.getElementById('issueUploadedFiles');
                if (!container) return;

                if (this.issueFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                const filesHtml = this.issueFiles.map((file, index) => `
                    <div class="uploaded-file" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file" style="color: #3b82f6;"></i>
                            <div>
                                <div style="font-size: 0.9rem; color: #374151;">${file.name}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">${this.formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button 
                            type="button"
                            onclick="window.orderDetailsManager.removeIssueFile(${index})" 
                            style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.2s ease;"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');

                container.innerHTML = filesHtml;
            }

            removeIssueFile(index) {
                this.issueFiles.splice(index, 1);
                this.updateIssueFilesList();
            }

            async submitRaiseIssueForm(transactionId, orderId) {
                console.log('📤 Submitting raise issue form');

                const submitBtn = document.getElementById('submitRaiseIssueBtn');
                if (!submitBtn) return;

                // Validate form
                const selectedItems = document.querySelectorAll('input[name="issue_items"]:checked');
                if (selectedItems.length === 0) {
                    alert('Please select at least one item with a problem.');
                    return;
                }

                const shortDesc = document.getElementById('short_description').value.trim();
                const longDesc = document.getElementById('long_description').value.trim();

                if (!shortDesc || !longDesc) {
                    alert('Please fill in both short and long descriptions.');
                    return;
                }

                // Disable button and show loading state
                submitBtn.disabled = true;
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner"></div> Submitting...';

                try {
                    // Prepare form data
                    const formData = new FormData();
                    formData.append('transaction_id', transactionId);
                    formData.append('order_id', orderId);
                    formData.append('category', document.getElementById('category').value);
                    formData.append('sub_category', document.getElementById('sub_category').value);
                    formData.append('short_description', shortDesc);
                    formData.append('long_description', longDesc);
                    formData.append('email', document.getElementById('email').value);

                    // Add selected items
                    const items = [];
                    selectedItems.forEach(checkbox => {
                        const itemId = checkbox.value;
                        const quantityInput = document.querySelector(`input[name="item_quantity_${itemId}"]`);
                        items.push({
                            item_id: itemId,
                            title: checkbox.dataset.title,
                            quantity: quantityInput ? quantityInput.value : 1,
                            price: checkbox.dataset.price
                        });
                    });
                    formData.append('items', JSON.stringify(items));

                    // Add files
                    if (this.issueFiles && this.issueFiles.length > 0) {
                        this.issueFiles.forEach((file, index) => {
                            formData.append(`images[${index}]`, file);
                        });
                    }

                    console.log('📋 Form data prepared:', {
                        transaction_id: transactionId,
                        order_id: orderId,
                        items_count: items.length,
                        files_count: this.issueFiles ? this.issueFiles.length : 0
                    });

                    // Make API call to Laravel backend
                    const apiUrl = 'https://neo-server.rozana.in/issues/raise';
                    console.log('📡 Calling raise issue API:', apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('📡 Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('✅ Issue raised successfully:', result);

                    // Close the modal
                    document.getElementById('raiseIssueModal').remove();

                    // Show success message
                    this.showSuccessMessage('Issue Raised Successfully!', `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                            <h3 style="color: #10b981; margin-bottom: 1rem;">Issue Raised Successfully!</h3>
                            <p style="margin-bottom: 1rem;">Your issue has been submitted and will be processed shortly.</p>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Order ID:</strong> ${orderId}</div>
                                <div><strong>Items:</strong> ${items.length} item(s)</div>
                                <div><strong>Files:</strong> ${this.issueFiles.length} file(s)</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                You will be notified of any updates regarding your issue.
                            </p>
                        </div>
                    `);

                    // Clear issue files
                    this.issueFiles = [];

                    // Reload order details
                    setTimeout(() => {
                        console.log('🔄 Reloading order details after issue raised...');
                        this.loadOrderDetails();
                    }, 2000);

                } catch (error) {
                    console.error('❌ Failed to raise issue:', error);
                    
                    // Show error message
                    this.showErrorMessage('Failed to Raise Issue', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Issue Submission Failed</h3>
                            <p style="margin-bottom: 1rem;">Unable to submit your issue at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Order ID:</strong> ${orderId}</div>
                                <div><strong>Error:</strong> ${error.message}</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                Please try again or contact support if the issue persists.
                            </p>
                        </div>
                    `);

                    // Restore button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalContent;
                }
            }

            async closeIssue(transactionId) {
                console.log('🔒 Closing issue for:', { transactionId });
                
                const button = document.getElementById('closeIssueBtn');
                if (!button) {
                    console.error('❌ Close Issue button not found!');
                    return;
                }

                // Confirm action with user
                const confirmed = confirm('Are you sure you want to close this issue? This action cannot be undone.');
                if (!confirmed) {
                    console.log('❌ User cancelled issue closure');
                    return;
                }

                // Disable button and show loading state
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div> Closing Issue...';

                try {
                    // Prepare API request
                    const apiUrl = 'https://neo-server.rozana.in/issues/close';
                    const requestData = {
                        transaction_id: transactionId
                    };

                    console.log('📡 Sending close issue request:', requestData);
                    console.log('🌐 Current origin:', window.location.origin);
                    console.log('🌐 Current protocol:', window.location.protocol);
                    console.log('🔗 API URL:', apiUrl);
                    console.log('📦 Request payload:', JSON.stringify(requestData, null, 2));

                    let response = null;
                    let successMethod = null;
                    let lastError = null;

                    // Method 1: Direct external API call
                    try {
                        console.log('🔄 Direct call to external API for close issue...');
                        console.log('📡 Calling:', apiUrl);
                        console.log('📦 Payload:', JSON.stringify(requestData, null, 2));
                        
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        if (response.ok) {
                            successMethod = 'Direct External API';
                            console.log('✅ External API request successful');
                        } else {
                            console.log(`❌ External API failed with status: ${response.status} ${response.statusText}`);
                            try {
                                const errorText = await response.text();
                                console.log('❌ API Error Response:', errorText);
                            } catch (e) {
                                console.log('❌ Could not read error response');
                            }
                        }
                    } catch (error) {
                        lastError = error;
                        console.log('❌ Direct external API call failed:', error.message);
                    }

                    // Method 2: Try with CORS headers if direct failed
                    if (!response || !response.ok) {
                        try {
                            console.log('🔄 Method 2: Trying with CORS headers for close issue...');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.ok) {
                                successMethod = 'CORS API';
                                console.log('✅ CORS API successful for close issue');
                            } else {
                                console.log(`❌ CORS API failed with status: ${response.status} ${response.statusText}`);
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ CORS API failed for close issue:', error.message);
                        }
                    }

                    // Method 3: Fallback for file protocol
                    if ((!response || !response.ok) && (window.location.protocol === 'file:' || window.location.origin === 'null')) {
                        try {
                            console.log('🔄 Method 3: Trying no-cors fallback for file:// protocol...');
                            console.log('⚠️ Using external API as fallback (cannot verify success)');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.type === 'opaque') {
                                successMethod = 'External API (No-CORS Fallback)';
                                console.log('✅ External API request sent (opaque response)');
                                // Create a mock response since we can't read opaque responses
                                response = { 
                                    ok: true, 
                                    json: () => Promise.resolve({ 
                                        success: true, 
                                        message: 'Issue close request sent to external API (success cannot be verified)',
                                        data: [],
                                        note: 'This is a fallback mode - actual success depends on server processing'
                                    }) 
                                };
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ External API fallback failed:', error.message);
                        }
                    }

                    if (!response || !response.ok) {
                        const errorMessage = lastError ? lastError.message : `HTTP error! status: ${response?.status || 'Network Error'}`;
                        console.error('❌ All methods failed. Last error:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('✅ Issue closed successfully:', result);

                    // Show success message
                    this.showSuccessMessage('Issue Closed Successfully!', `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                            <h3 style="color: #10b981; margin-bottom: 1rem;">Issue Closed Successfully!</h3>
                            <p style="margin-bottom: 1rem;">Your issue has been marked as closed and the seller has been notified.</p>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Response:</strong> ${result.message || 'Success'}</div>
                                <div><strong>Method:</strong> ${successMethod}</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                The issue status will be updated shortly.
                            </p>
                        </div>
                    `);

                    // Update button to show closed state
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Issue Closed';
                    button.style.background = '#10b981';
                    button.disabled = true;

                    // Optionally reload the page data after a delay
                    setTimeout(() => {
                        console.log('🔄 Reloading order details after issue closure...');
                        this.loadOrderDetails();
                    }, 2000);

                } catch (error) {
                    console.error('❌ Failed to close issue:', error);
                    
                    // Determine error type and provide specific guidance
                    let errorType = 'Unknown Error';
                    let troubleshootingTips = '';
                    
                    if (error.message.includes('Network Error') || error.message.includes('Failed to fetch')) {
                        errorType = 'Network Connection Error';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>Troubleshooting Tips:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li>Check your internet connection</li>
                                    <li>Try refreshing the page</li>
                                    <li>Disable any ad blockers or VPN</li>
                                    <li>Check if the server is accessible: <a href="https://neo-server.rozana.in" target="_blank" style="color: #3b82f6;">neo-server.rozana.in</a></li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('CORS') || window.location.protocol === 'file:') {
                        errorType = 'File Protocol Issue';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>File Protocol Detected - Use Web Server Instead:</strong>
                                <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><strong>Option 1 (Recommended):</strong> Double-click <code>start-local-server.bat</code> in the project folder</li>
                                    <li><strong>Option 2:</strong> Use XAMPP - Access via <code>http://localhost/rozana_ondc/order-details.html</code></li>
                                </ol>
                            </div>
                        `;
                    }
                    
                    // Show detailed error message
                    this.showErrorMessage('Failed to Close Issue', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Issue Closure Failed</h3>
                            <p style="margin-bottom: 1rem;">Unable to close the issue at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Error Type:</strong> ${errorType}</div>
                                <div><strong>Error Details:</strong> ${error.message}</div>
                                <div><strong>Current Protocol:</strong> ${window.location.protocol}</div>
                                <div><strong>Current Origin:</strong> ${window.location.origin}</div>
                            </div>
                            ${troubleshootingTips}
                            <p style="font-size: 0.9rem; color: #6b7280; margin-top: 1rem;">
                                If the issue persists, please contact support with the above details.
                            </p>
                        </div>
                    `);

                    // Restore button state
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }

            async escalateIssue(transactionId, issueId) {
                console.log('🚨 Escalating issue for:', { transactionId, issueId });
                
                const button = document.getElementById('escalationBtn');
                if (!button) {
                    console.error('❌ Escalation button not found!');
                    return;
                }

                // Confirm action with user
                const confirmed = confirm('Are you sure you want to escalate this issue? This will notify the seller and may involve higher-level support.');
                if (!confirmed) {
                    console.log('❌ User cancelled issue escalation');
                    return;
                }

                // Disable button and show loading state
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.innerHTML = '<div class="spinner"></div> Escalating...';

                try {
                    // Prepare API request
                    const apiUrl = 'https://neo-server.rozana.in/issues/escalate';
                    const requestData = {
                        transaction_id: transactionId,
                        issue_id: issueId
                    };

                    console.log('📡 Sending escalation request:', requestData);
                    console.log('🌐 API URL:', apiUrl);

                    let response = null;
                    let successMethod = null;
                    let lastError = null;

                    // Method 1: Direct external API call
                    try {
                        console.log('🔄 Direct call to external API for escalation...');
                        console.log('📡 Calling:', apiUrl);
                        console.log('📦 Payload:', JSON.stringify(requestData, null, 2));
                        
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        if (response.ok) {
                            successMethod = 'Direct External API';
                            console.log('✅ External API request successful');
                        } else {
                            console.log(`❌ External API failed with status: ${response.status} ${response.statusText}`);
                            try {
                                const errorText = await response.text();
                                console.log('❌ API Error Response:', errorText);
                            } catch (e) {
                                console.log('❌ Could not read error response');
                            }
                        }
                    } catch (error) {
                        lastError = error;
                        console.log('❌ Direct external API call failed:', error.message);
                    }

                    // Method 2: Try with CORS headers if direct failed
                    if (!response || !response.ok) {
                        try {
                            console.log('🔄 Method 2: Trying with CORS headers for escalation...');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.ok) {
                                successMethod = 'CORS API';
                                console.log('✅ CORS API successful for escalation');
                            } else {
                                console.log(`❌ CORS API failed with status: ${response.status} ${response.statusText}`);
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ CORS API failed for escalation:', error.message);
                        }
                    }

                    // Method 3: Fallback for file protocol
                    if ((!response || !response.ok) && (window.location.protocol === 'file:' || window.location.origin === 'null')) {
                        try {
                            console.log('🔄 Method 3: Trying no-cors fallback for file:// protocol...');
                            console.log('⚠️ Using external API as fallback (cannot verify success)');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });

                            if (response.type === 'opaque') {
                                successMethod = 'External API (No-CORS Fallback)';
                                console.log('✅ External API request sent (opaque response)');
                                // Create a mock response since we can't read opaque responses
                                response = { 
                                    ok: true, 
                                    json: () => Promise.resolve({ 
                                        success: true, 
                                        message: 'Issue escalation request sent to external API (success cannot be verified)',
                                        data: [],
                                        note: 'This is a fallback mode - actual success depends on server processing'
                                    }) 
                                };
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ External API fallback failed:', error.message);
                        }
                    }

                    if (!response || !response.ok) {
                        const errorMessage = lastError ? lastError.message : `HTTP error! status: ${response?.status || 'Network Error'}`;
                        console.error('❌ All methods failed. Last error:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('✅ Issue escalated successfully:', result);

                    // Show success message
                    this.showSuccessMessage('Issue Escalated Successfully!', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                            <h3 style="color: #f59e0b; margin-bottom: 1rem;">Issue Escalated Successfully!</h3>
                            <p style="margin-bottom: 1rem;">Your issue has been escalated and the seller has been notified of the escalation.</p>
                            <div style="background: #fffbeb; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Issue ID:</strong> ${issueId}</div>
                                <div><strong>Response:</strong> ${result.message || 'Success'}</div>
                                <div><strong>Method:</strong> ${successMethod}</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                The seller will be notified and may provide additional support or resolution options.
                            </p>
                        </div>
                    `);

                    // Update button to show escalated state
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Issue Escalated';
                    button.style.background = '#f59e0b';
                    button.disabled = true;

                    // Optionally reload the page data after a delay
                    setTimeout(() => {
                        console.log('🔄 Reloading order details after issue escalation...');
                        this.loadOrderDetails();
                    }, 2000);

                } catch (error) {
                    console.error('❌ Failed to escalate issue:', error);
                    
                    // Determine error type and provide specific guidance
                    let errorType = 'Unknown Error';
                    let troubleshootingTips = '';
                    
                    if (error.message.includes('Network Error') || error.message.includes('Failed to fetch')) {
                        errorType = 'Network Connection Error';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>Troubleshooting Tips:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li>Check your internet connection</li>
                                    <li>Try refreshing the page</li>
                                    <li>Disable any ad blockers or VPN</li>
                                    <li>Check if the server is accessible: <a href="https://neo-server.rozana.in" target="_blank" style="color: #3b82f6;">neo-server.rozana.in</a></li>
                                </ul>
                            </div>
                        `;
                    } else if (error.message.includes('CORS') || window.location.protocol === 'file:') {
                        errorType = 'File Protocol Issue';
                        troubleshootingTips = `
                            <div style="text-align: left; margin-top: 1rem;">
                                <strong>File Protocol Detected - Use Web Server Instead:</strong>
                                <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    <li><strong>Option 1 (Recommended):</strong> Double-click <code>start-local-server.bat</code> in the project folder</li>
                                    <li><strong>Option 2:</strong> Use XAMPP - Access via <code>http://localhost/rozana_ondc/order-details.html</code></li>
                                </ol>
                            </div>
                        `;
                    }
                    
                    // Show detailed error message
                    this.showErrorMessage('Failed to Escalate Issue', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Issue Escalation Failed</h3>
                            <p style="margin-bottom: 1rem;">Unable to escalate the issue at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Issue ID:</strong> ${issueId}</div>
                                <div><strong>Error Type:</strong> ${errorType}</div>
                                <div><strong>Error Details:</strong> ${error.message}</div>
                                <div><strong>Current Protocol:</strong> ${window.location.protocol}</div>
                                <div><strong>Current Origin:</strong> ${window.location.origin}</div>
                            </div>
                            ${troubleshootingTips}
                            <p style="font-size: 0.9rem; color: #6b7280; margin-top: 1rem;">
                                If the issue persists, please contact support with the above details.
                            </p>
                        </div>
                    `);

                    // Restore button state
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }

            async showIssueStatus(transactionId) {
                console.log('📊 Showing issue status for:', { transactionId });
                
                try {
                    // Prepare API request
                    const apiUrl = 'https://neo-server.rozana.in/issues/issue_status';
                    const requestData = {
                        transaction_id: transactionId
                    };

                    console.log('📡 Sending issue status request:', requestData);
                    console.log('🌐 API URL:', apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('📡 Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('✅ Issue status retrieved successfully:', result);

                    // Show issue status in a modal
                    this.showModal('Issue Status', `
                        <div style="text-align: center;">
                            <i class="fas fa-info-circle" style="font-size: 3rem; color: #3b82f6; margin-bottom: 1rem;"></i>
                            <h3 style="color: #3b82f6; margin-bottom: 1rem;">Issue Status Details</h3>
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Status:</strong> ${result.data?.status || 'Unknown'}</div>
                                <div><strong>Message:</strong> ${result.message || 'Success'}</div>
                                ${result.data?.issue_id ? `<div><strong>Issue ID:</strong> ${result.data.issue_id}</div>` : ''}
                                ${result.data?.created_at ? `<div><strong>Created:</strong> ${result.data.created_at}</div>` : ''}
                                ${result.data?.updated_at ? `<div><strong>Updated:</strong> ${result.data.updated_at}</div>` : ''}
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                This shows the current status of your issue.
                            </p>
                        </div>
                    `);

                } catch (error) {
                    console.error('❌ Failed to get issue status:', error);
                    
                    // Show error message
                    this.showErrorMessage('Failed to Get Issue Status', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Failed to Get Issue Status</h3>
                            <p style="margin-bottom: 1rem;">Unable to retrieve the issue status at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Error:</strong> ${error.message}</div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                Please try again or contact support if the issue persists.
                            </p>
                        </div>
                    `);
                }
            }

            showModal(title, content, type = 'info') {
                // Remove existing modal if any
                const existingModal = document.getElementById('proposalModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'proposalModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                `;

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin: 0; color: #1e293b;">${title}</h2>
                        <button onclick="document.getElementById('proposalModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    ${content}
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button onclick="document.getElementById('proposalModal').remove()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            showLoading() {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('orderContent').style.display = 'none';
            }

            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('orderContent').style.display = 'none';
            }

            showContent() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('orderContent').style.display = 'block';
                
                // Initialize file upload handlers after content is shown
                this.initializeFileUpload();
            }

            initializeFileUpload() {
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.querySelector('.file-upload-area');
                const uploadedFilesContainer = document.getElementById('uploadedFiles');
                
                console.log('🔧 Initializing file upload...', {
                    fileInput: !!fileInput,
                    uploadArea: !!uploadArea,
                    uploadedFilesContainer: !!uploadedFilesContainer
                });
                
                if (!fileInput || !uploadArea) {
                    console.log('❌ File upload elements not found, skipping initialization');
                    return;
                }

                // Initialize uploadedFiles array if not already done
                if (!this.uploadedFiles) {
                    this.uploadedFiles = [];
                }

                // Remove existing event listeners to prevent duplicates
                const newFileInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newFileInput, fileInput);
                
                const newUploadArea = uploadArea.cloneNode(true);
                uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);

                // Add event listeners to the new elements
                newFileInput.addEventListener('change', (e) => {
                    console.log('📁 File input changed:', e.target.files.length, 'files');
                    this.handleFileSelection(e.target.files);
                });

                // Drag and drop handlers
                newUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    newUploadArea.classList.add('dragover');
                });

                newUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    newUploadArea.classList.remove('dragover');
                });

                newUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    newUploadArea.classList.remove('dragover');
                    console.log('📁 Files dropped:', e.dataTransfer.files.length, 'files');
                    this.handleFileSelection(e.dataTransfer.files);
                });
                
                console.log('✅ File upload initialized successfully');
            }

            handleFileSelection(files) {
                console.log('🔍 handleFileSelection called with:', files.length, 'files');
                
                const maxSize = 5 * 1024 * 1024; // 5MB
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

                Array.from(files).forEach((file, index) => {
                    console.log(`📁 Processing file ${index + 1}:`, {
                        name: file.name,
                        size: file.size,
                        type: file.type
                    });
                    // Validate file size
                    if (file.size > maxSize) {
                        alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                        return;
                    }

                    // Validate file type
                    if (!allowedTypes.includes(file.type)) {
                        alert(`File "${file.name}" is not supported. Please upload JPG, PNG, PDF, or DOC files.`);
                        return;
                    }

                    // Check if file already exists
                    if (this.uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        alert(`File "${file.name}" is already selected.`);
                        return;
                    }

                    // Add file to uploaded files
                    this.uploadedFiles.push(file);
                    console.log('✅ File added to uploadedFiles:', file.name, '| Total files:', this.uploadedFiles.length);
                    this.updateUploadedFilesList();
                });
            }

            updateUploadedFilesList() {
                const container = document.getElementById('uploadedFiles');
                if (!container) return;

                if (this.uploadedFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                const filesHtml = this.uploadedFiles.map((file, index) => `
                    <div class="uploaded-file">
                        <div class="file-info">
                            <i class="fas fa-file file-icon"></i>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${this.formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button class="remove-file-btn" onclick="window.orderDetailsManager.removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');

                container.innerHTML = filesHtml;
            }

            removeFile(index) {
                this.uploadedFiles.splice(index, 1);
                this.updateUploadedFilesList();
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async submitAdditionalInfo(transactionId) {
                console.log('📤 Submitting additional info for:', { transactionId });
                
                const description = document.getElementById('issueDescription')?.value?.trim();
                const submitBtn = document.getElementById('submitInfoBtn');
                
                if (!description) {
                    alert('Please provide a description before submitting.');
                    return;
                }

                if (!submitBtn) return;

                // Disable button and show loading state
                submitBtn.disabled = true;
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner"></div> Submitting...';

                try {
                    // Prepare form data
                    const formData = new FormData();
                    formData.append('transaction_id', transactionId);
                    formData.append('description', description); // Use 'description' to match Laravel API
                    
                    // Add files to form data with correct field names for array handling
                    if (this.uploadedFiles && Array.isArray(this.uploadedFiles)) {
                        this.uploadedFiles.forEach((file, index) => {
                            formData.append(`images[${index}]`, file); // Use 'images[]' array format for Laravel
                        });
                    }

                    console.log('📋 Form data prepared:', {
                        transaction_id: transactionId,
                        description: description,
                        files_count: this.uploadedFiles ? this.uploadedFiles.length : 0
                    });

                    // Log FormData contents for debugging
                    console.log('📋 FormData entries:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}:`, value instanceof File ? `File: ${value.name} (${value.size} bytes)` : value);
                    }

                    // Make API call to upload additional info
                    const apiUrl = 'https://neo-server.rozana.in/issues/upload-additional-info';
                    
                    console.log('📡 Calling upload additional info API:', apiUrl);
                    
                    let response = null;
                    let successMethod = null;
                    let lastError = null;

                    // Method 1: Try direct API call first
                    try {
                        console.log('🔄 Method 1: Trying direct API for upload additional info...');
                        
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            body: formData // Don't set Content-Type header for FormData, let browser set it
                        });

                        if (response.ok) {
                            successMethod = 'Direct API';
                            console.log('✅ Direct API successful for upload additional info');
                        } else {
                            console.log(`❌ Direct API failed with status: ${response.status}`);
                        }
                    } catch (error) {
                        lastError = error;
                        console.log('❌ Direct API failed for upload additional info:', error.message);
                    }

                    // Method 2: Try with CORS headers if direct failed
                    if (!response || !response.ok) {
                        try {
                            console.log('🔄 Method 2: Trying with CORS headers for upload additional info...');
                            
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                body: formData
                            });

                            if (response.ok) {
                                successMethod = 'CORS API';
                                console.log('✅ CORS API successful for upload additional info');
                            } else {
                                console.log(`❌ CORS API failed with status: ${response.status}`);
                            }
                        } catch (error) {
                            lastError = error;
                            console.log('❌ CORS API failed for upload additional info:', error.message);
                        }
                    }

                    if (!response || !response.ok) {
                        const errorMessage = lastError ? lastError.message : `HTTP error! status: ${response?.status || 'Network Error'}`;
                        console.error('❌ All methods failed. Last error:', errorMessage);
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    console.log('✅ Additional info uploaded successfully:', result);
                    
                    // Show success message with API response data
                    this.showSuccessMessage('Information Submitted Successfully!', `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                            <h3 style="color: #10b981; margin-bottom: 1rem;">Additional Information Submitted!</h3>
                            <p style="margin-bottom: 1rem;">Your additional information has been sent to the seller.</p>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Description:</strong> ${description}</div>
                                <div><strong>Files Uploaded:</strong> ${result.data?.images_uploaded || (this.uploadedFiles ? this.uploadedFiles.length : 0)}</div>
                                <div><strong>Upload Status:</strong> ${result.message || 'Success'}</div>
                                <div><strong>Method:</strong> ${successMethod}</div>
                                ${result.data?.image_urls?.length > 0 ? `<div><strong>Image URLs:</strong> ${result.data.image_urls.length} files uploaded</div>` : ''}
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                The seller will review your information and respond accordingly.
                            </p>
                        </div>
                    `);

                    // Update button to show success state
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Information Submitted';
                    submitBtn.style.background = '#10b981';
                    submitBtn.disabled = true;

                    // Clear form
                    document.getElementById('issueDescription').value = '';
                    this.uploadedFiles = [];
                    if (typeof this.updateUploadedFilesList === 'function') {
                        this.updateUploadedFilesList();
                    }

                    // Optionally reload the page data after a delay
                    setTimeout(() => {
                        console.log('🔄 Reloading order details after info submission...');
                        this.loadOrderDetails();
                    }, 2000);

                } catch (error) {
                    console.error('❌ Failed to submit additional info:', error);
                    
                    // Try to parse error response for more details
                    let errorDetails = error.message;
                    let validationErrors = '';
                    
                    if (response && !response.ok) {
                        try {
                            const errorData = await response.json();
                            if (errorData.errors) {
                                validationErrors = Object.entries(errorData.errors)
                                    .map(([field, messages]) => `<div><strong>${field}:</strong> ${Array.isArray(messages) ? messages.join(', ') : messages}</div>`)
                                    .join('');
                            }
                            if (errorData.message) {
                                errorDetails = errorData.message;
                            }
                            if (errorData.debug_info) {
                                console.log('🐛 Debug info from API:', errorData.debug_info);
                            }
                        } catch (parseError) {
                            console.log('Could not parse error response:', parseError);
                        }
                    }
                    
                    // Show error message
                    this.showErrorMessage('Failed to Submit Information', `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc2626; margin-bottom: 1rem;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 1rem;">Submission Failed</h3>
                            <p style="margin-bottom: 1rem;">Unable to submit your additional information at this time.</p>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div><strong>Transaction ID:</strong> ${transactionId}</div>
                                <div><strong>Error:</strong> ${errorDetails}</div>
                                ${validationErrors ? `<div style="margin-top: 0.5rem;"><strong>Validation Errors:</strong><br>${validationErrors}</div>` : ''}
                            </div>
                            <p style="font-size: 0.9rem; color: #6b7280;">
                                Please check the form data and try again, or contact support if the problem persists.
                            </p>
                        </div>
                    `);

                    // Restore button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalContent;
                }
            }

            showContent() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('orderContent').style.display = 'block';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.orderDetailsManager = new OrderDetailsManager();
            
            // Global test function for debugging
            window.testOrderDetailsAPI = async function(transactionId) {
                const testId = transactionId || window.orderDetailsManager.transactionId;
                if (!testId) {
                    console.log('❌ No transaction ID provided');
                    return;
                }
                
                console.log('🧪 TESTING ORDER DETAILS API...');
                console.log('📋 Transaction ID:', testId);
                
                const apiUrl = 'https://neo-server.rozana.in/searchOrder/';
                const fullUrl = apiUrl + testId;
                
                console.log('🔗 Full API URL:', fullUrl);
                
                try {
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        },
                        cache: 'no-store'
                    });
                    
                    console.log('📡 Response Status:', response.status);
                    console.log('📡 Response Headers:', [...response.headers.entries()]);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ API Response Data:', data);
                        return data;
                    } else {
                        const errorText = await response.text();
                        console.log('❌ API Error Response:', errorText);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ API Test Failed:', error);
                    return null;
                }
            };
            
            // Test PHP proxy
            window.testProxyAPI = async function(transactionId) {
                const testId = transactionId || window.orderDetailsManager.transactionId;
                if (!testId) {
                    console.log('❌ No transaction ID provided');
                    return;
                }
                
                console.log('🧪 TESTING PHP PROXY API...');
                console.log('📋 Transaction ID:', testId);
                
                const apiUrl = 'https://neo-server.rozana.in/searchOrder/';
                const targetUrl = apiUrl + testId;
                const proxyUrl = `./api-proxy.php?url=${encodeURIComponent(targetUrl)}`;
                
                console.log('🔗 Target URL:', targetUrl);
                console.log('🔗 Proxy URL:', proxyUrl);
                
                try {
                    const response = await fetch(proxyUrl);
                    console.log('📡 Proxy Response Status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ Proxy Response Data:', data);
                        return data;
                    } else {
                        const errorText = await response.text();
                        console.log('❌ Proxy Error Response:', errorText);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ Proxy Test Failed:', error);
                    return null;
                }
            };

            // Test function to debug raise issue API
            // Test function for Upload Additional Info API
            window.testUploadAdditionalInfoAPI = async function(transactionId) {
                console.log('🧪 Testing Upload Additional Info API...');
                
                const apiUrl = 'https://neo-server.rozana.in/issues/upload-additional-info';
                
                // Create test form data
                const formData = new FormData();
                formData.append('transaction_id', transactionId || '7fd329ac-00b6-46dd-933f-ec8d5caecec6');
                formData.append('short_desc', 'test upload');
                
                // Create a test file (small text file)
                const testFile = new File(['test content'], 'test.txt', { type: 'text/plain' });
                formData.append('image', testFile);
                
                console.log('📡 Testing API:', apiUrl);
                console.log('📦 FormData entries:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}:`, value instanceof File ? `File: ${value.name} (${value.size} bytes)` : value);
                }
                
                try {
                    console.log('🔄 Making test request...');
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('📡 Response status:', response.status);
                    console.log('📡 Response headers:', [...response.headers.entries()]);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ API Response:', result);
                    } else {
                        const errorText = await response.text();
                        console.log('❌ API Error Response:', errorText);
                    }
                } catch (error) {
                    console.log('❌ Request failed:', error.message);
                }
                
                console.log('🧪 Upload API test completed. Check console for details.');
            };

            // Test function for Accept Proposal API
            window.testAcceptProposalAPI = async function(transactionId) {
                console.log('🧪 Testing Accept Proposal API connectivity...');
                
                const apiUrl = 'https://neo-server.rozana.in/issues/accept-proposal';
                const requestData = { transaction_id: transactionId || '463ecfc0-aba7-401f-9ef6-5fd2f77c77e4' };
                
                console.log('📡 Testing API:', apiUrl);
                console.log('📦 Request data:', requestData);
                console.log('🌐 Current protocol:', window.location.protocol);
                console.log('🌐 Current origin:', window.location.origin);
                
                // Test different methods
                const methods = [
                    {
                        name: 'PHP Proxy',
                        test: async () => {
                            const proxyUrl = `./api-proxy.php?url=${encodeURIComponent(apiUrl)}`;
                            return await fetch(proxyUrl, {
                                method: 'POST',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });
                        }
                    },
                    {
                        name: 'Direct API (CORS)',
                        test: async () => {
                            return await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json',
                                    'Cache-Control': 'no-cache'
                                },
                                body: JSON.stringify(requestData)
                            });
                        }
                    },
                    {
                        name: 'No-CORS Mode',
                        test: async () => {
                            return await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });
                        }
                    }
                ];
                
                for (const method of methods) {
                    try {
                        console.log(`🔄 Testing ${method.name}...`);
                        const response = await method.test();
                        console.log(`✅ ${method.name} - Status:`, response.status, 'Type:', response.type);
                        
                        if (response.ok || response.type === 'opaque') {
                            console.log(`🎉 ${method.name} appears to be working!`);
                            if (response.type !== 'opaque') {
                                try {
                                    const result = await response.text();
                                    console.log(`📄 ${method.name} Response:`, result);
                                } catch (e) {
                                    console.log(`📄 ${method.name} Response could not be read:`, e.message);
                                }
                            }
                        }
                    } catch (error) {
                        console.log(`❌ ${method.name} failed:`, error.message);
                    }
                }
                
                console.log('🧪 API connectivity test completed. Check console for details.');
            };

            window.testRaiseIssueAPI = async function(transactionId) {
                const testTransactionId = transactionId || '2b584dd0-db2b-410c-834f-8973751e5972';
                console.log('🧪 TESTING RAISE ISSUE API...');
                console.log('📋 Transaction ID:', testTransactionId);
                
                const apiUrl = `https://neo-server.rozana.in/issues/raise/${testTransactionId}`;
                console.log('🔗 API URL:', apiUrl);
                console.log('🌐 Current Protocol:', window.location.protocol);
                console.log('🌐 Current Origin:', window.location.origin);
                
                // Test 1: PHP Proxy
                try {
                    console.log('\n🔄 Testing PHP Proxy...');
                    const proxyUrl = `./api-proxy.php?url=${encodeURIComponent(apiUrl)}`;
                    console.log('📡 Proxy URL:', proxyUrl);
                    
                    const proxyResponse = await fetch(proxyUrl);
                    console.log('📡 Proxy Status:', proxyResponse.status);
                    console.log('📡 Proxy Headers:', [...proxyResponse.headers.entries()]);
                    
                    if (proxyResponse.ok) {
                        const proxyData = await proxyResponse.json();
                        console.log('✅ PHP Proxy Success:', proxyData);
                    } else {
                        const errorText = await proxyResponse.text();
                        console.log('❌ PHP Proxy Error:', errorText);
                    }
                } catch (error) {
                    console.log('❌ PHP Proxy Failed:', error);
                }
                
                // Test 2: AllOrigins Proxy
                try {
                    console.log('\n🔄 Testing AllOrigins Proxy...');
                    const corsUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
                    console.log('📡 CORS URL:', corsUrl);
                    
                    const corsResponse = await fetch(corsUrl);
                    console.log('📡 CORS Status:', corsResponse.status);
                    
                    if (corsResponse.ok) {
                        const corsData = await corsResponse.json();
                        console.log('✅ AllOrigins Success:', corsData);
                        if (corsData.contents) {
                            const parsedData = JSON.parse(corsData.contents);
                            console.log('✅ Parsed API Data:', parsedData);
                        }
                    } else {
                        console.log('❌ AllOrigins Error:', corsResponse.statusText);
                    }
                } catch (error) {
                    console.log('❌ AllOrigins Failed:', error);
                }
                
                // Test 3: Direct API (will likely fail due to CORS)
                try {
                    console.log('\n🔄 Testing Direct API (expected to fail due to CORS)...');
                    const directResponse = await fetch(apiUrl);
                    console.log('📡 Direct Status:', directResponse.status);
                    
                    if (directResponse.ok) {
                        const directData = await directResponse.json();
                        console.log('✅ Direct API Success (unexpected):', directData);
                    }
                } catch (error) {
                    console.log('❌ Direct API Failed (expected):', error.message);
                }
                
                console.log('\n🎯 Test completed. Check the results above.');
            };
            
            // Test function to simulate order without issues (for raise issue button)
            window.testWithoutIssues = function() {
                console.log('🧪 Testing with order without issues...');
                
                const mockOrderData = {
                    order_id: 143,
                    transaction_id: 'test-transaction-143',
                    ondc_order_id: 'O1758991924226',
                    order_status: 'Completed',
                    total_value: '145.00',
                    currency: 'INR',
                    payment_status: 'PAID',
                    payment_mode: 'Prepaid',
                    provider_id: 'pramaan_provider_1',
                    provider_location_id: 'SSL1',
                    total_items: 1,
                    total_quantity: '1',
                    created_at: '2025-09-29 16:50:03',
                    updated_at: '2025-09-29 18:20:04',
                    issue_raised: 0,
                    issue_details: null,
                    issue_actions: [],
                    order_details: [
                        {
                            title: 'Plain Atta',
                            quantity: 1,
                            amount: '65.00',
                            currency: 'INR',
                            status: 'Completed',
                            item_id: 'id_13owvn_0_0'
                        }
                    ]
                };
                
                console.log('📋 Mock order data without issues:', mockOrderData);
                
                if (window.orderDetailsManager) {
                    window.orderDetailsManager.displayOrderDetails(mockOrderData);
                    console.log('✅ Displayed mock data without issues - should show raise issue button');
                } else {
                    console.log('❌ OrderDetailsManager not available');
                }
            };

            // Test function to simulate INFO_REQUESTED issue data
            window.testWithInfoRequested = function() {
                console.log('🧪 Testing with INFO_REQUESTED issue data...');
                
                const mockOrderData = {
                    order_id: 142,
                    transaction_id: 'efbb4c5b-c6b1-4011-a593-51a446a2c009',
                    ondc_order_id: 'O1758991924225',
                    order_status: 'Completed',
                    total_value: '145.00',
                    currency: 'INR',
                    payment_status: 'NOT-PAID',
                    payment_mode: 'ON-Fulfillment',
                    provider_id: 'pramaan_provider_1',
                    provider_location_id: 'SSL1',
                    total_items: 1,
                    total_quantity: '1',
                    created_at: '2025-09-27 16:50:03',
                    updated_at: '2025-09-27 22:20:04',
                    issue_raised: 1,
                    issue_details_status: 'PROCESSING',
                    issue_id: 'ISSUE-142-84',
                    issue_actions: {
                        action_status: 'INFO_REQUESTED'
                    },
                    issue_details: {
                        status: 'PROCESSING',
                        description: 'Product quality issue - additional information requested',
                        category: 'ITEM',
                        sub_category: 'QUALITY',
                        created_at: '2025-09-27 18:30:00',
                        updated_at: '2025-09-27 22:20:04',
                        actions: [
                            {
                                descriptor: { code: 'INFO_REQUESTED' },
                                action_type: 'INFO_REQUESTED',
                                description: 'Seller has requested additional information from buyer',
                                status: 'PENDING',
                                created_at: '2025-09-27 22:20:04'
                            },
                            {
                                descriptor: { code: 'ISSUE_RAISED' },
                                action_type: 'ISSUE_RAISED',
                                description: 'Issue raised by buyer regarding product quality',
                                status: 'COMPLETED',
                                created_at: '2025-09-27 18:30:00'
                            }
                        ]
                    },
                    order_details: [
                        {
                            title: 'Plain Atta',
                            quantity: 1,
                            amount: '65.00',
                            currency: 'INR',
                            status: 'Completed',
                            item_id: 'id_13owvn_0_0'
                        }
                    ]
                };
                
                console.log('📋 Mock order data with INFO_REQUESTED:', mockOrderData);
                
                if (window.orderDetailsManager) {
                    window.orderDetailsManager.displayOrderDetails(mockOrderData);
                    console.log('✅ Displayed mock data with INFO_REQUESTED - should show upload form');
                } else {
                    console.log('❌ OrderDetailsManager not available');
                }
            };

            // Test function to simulate 5 steps completed (like in screenshot)
            window.testWith5StepsCompleted = function() {
                console.log('🧪 Testing with 5 steps completed (Resolution Accepted)...');
                
                const mockOrderData = {
                    order_id: 142,
                    transaction_id: 'efbb4c5b-c6b1-4011-a593-51a446a2c009',
                    ondc_order_id: 'O1758991924225',
                    order_status: 'Completed',
                    total_value: '145.00',
                    currency: 'INR',
                    payment_status: 'NOT-PAID',
                    payment_mode: 'ON-Fulfillment',
                    provider_id: 'pramaan_provider_1',
                    provider_location_id: 'SSL1',
                    total_items: 1,
                    total_quantity: '1',
                    created_at: '2025-09-27 16:50:03',
                    updated_at: '2025-09-30 09:45:00',
                    issue_raised: 1,
                    issue_details_status: 'PROCESSING',
                    issue_id: 'ISSUE-142-84',
                    issue_actions: {
                        action_status: 'RESOLUTION_ACCEPTED'
                    },
                    issue_details: {
                        status: 'PROCESSING',
                        description: 'Product quality issue - resolution accepted, awaiting closure',
                        category: 'ITEM',
                        sub_category: 'QUALITY',
                        created_at: '2025-09-27 18:30:00',
                        updated_at: '2025-09-30 09:45:00',
                        actions: [
                            {
                                descriptor: { code: 'RESOLUTION_ACCEPTED' },
                                action_type: 'RESOLUTION_ACCEPTED',
                                description: 'Buyer accepted the proposed resolution',
                                status: 'COMPLETED',
                                created_at: '2025-09-30 09:45:00'
                            },
                            {
                                descriptor: { code: 'RESOLUTION_PROPOSED' },
                                action_type: 'RESOLUTION_PROPOSED',
                                description: 'Seller proposed a replacement for the damaged item',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 22:20:04'
                            },
                            {
                                descriptor: { code: 'INFO_PROVIDED' },
                                action_type: 'INFO_PROVIDED',
                                description: 'Buyer provided additional information and images',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 21:00:00'
                            },
                            {
                                descriptor: { code: 'INFO_REQUESTED' },
                                action_type: 'INFO_REQUESTED',
                                description: 'Additional information requested from buyer',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 20:15:00'
                            },
                            {
                                descriptor: { code: 'ISSUE_RAISED' },
                                action_type: 'ISSUE_RAISED',
                                description: 'Issue raised by buyer regarding product quality',
                                status: 'COMPLETED',
                                created_at: '2025-09-27 18:30:00'
                            }
                        ]
                    },
                    order_details: [
                        {
                            title: 'Plain Atta',
                            quantity: 1,
                            amount: '65.00',
                            currency: 'INR',
                            status: 'Completed',
                            item_id: 'id_13owvn_0_0'
                        }
                    ]
                };
                
                console.log('📋 Mock order data with 5 steps completed:', mockOrderData);
                
                if (window.orderDetailsManager) {
                    window.orderDetailsManager.displayOrderDetails(mockOrderData);
                    console.log('✅ Displayed mock data with 5 steps completed - should show 5/6 Steps Completed (83%)');
                } else {
                    console.log('❌ OrderDetailsManager not available');
                }
            };

            // Test function to simulate closed issue data
            window.testWithClosedIssue = function() {
                console.log('🧪 Testing with CLOSED issue data...');
                
                const mockOrderData = {
                    order_id: 143,
                    transaction_id: '121dbfa1-2c75-47c7-b05e-c1a3b8d958b4',
                    ondc_order_id: 'O1758991924227',
                    order_status: 'Completed',
                    total_value: '145.00',
                    currency: 'INR',
                    payment_status: 'PAID',
                    payment_mode: 'Prepaid',
                    provider_id: 'pramaan_provider_1',
                    provider_location_id: 'SSL1',
                    total_items: 1,
                    total_quantity: '1',
                    created_at: '2025-09-29 16:50:03',
                    updated_at: '2025-09-30 10:30:00',
                    issue_raised: 1,
                    issue_details_status: 'CLOSED',
                    issue_id: 'ISSUE-143-85',
                    issue_actions: {
                        action_status: 'ISSUE_CLOSED'
                    },
                    issue_details: {
                        status: 'CLOSED',
                        description: 'Product quality issue - resolved with replacement',
                        category: 'ITEM',
                        sub_category: 'QUALITY',
                        created_at: '2025-09-29 18:30:00',
                        updated_at: '2025-09-30 10:30:00',
                        actions: [
                            {
                                descriptor: { code: 'ISSUE_CLOSED' },
                                action_type: 'ISSUE_CLOSED',
                                description: 'Issue has been successfully resolved and closed',
                                status: 'COMPLETED',
                                created_at: '2025-09-30 10:30:00'
                            },
                            {
                                descriptor: { code: 'RESOLUTION_ACCEPTED' },
                                action_type: 'RESOLUTION_ACCEPTED',
                                description: 'Buyer accepted the proposed resolution',
                                status: 'COMPLETED',
                                created_at: '2025-09-30 09:45:00'
                            },
                            {
                                descriptor: { code: 'RESOLUTION_PROPOSED' },
                                action_type: 'RESOLUTION_PROPOSED',
                                description: 'Seller proposed a replacement for the damaged item',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 22:20:04'
                            },
                            {
                                descriptor: { code: 'INFO_PROVIDED' },
                                action_type: 'INFO_PROVIDED',
                                description: 'Buyer provided additional information and images',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 21:00:00'
                            },
                            {
                                descriptor: { code: 'INFO_REQUESTED' },
                                action_type: 'INFO_REQUESTED',
                                description: 'Additional information requested from buyer',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 20:15:00'
                            },
                            {
                                descriptor: { code: 'ISSUE_RAISED' },
                                action_type: 'ISSUE_RAISED',
                                description: 'Issue raised by buyer regarding product quality',
                                status: 'COMPLETED',
                                created_at: '2025-09-29 18:30:00'
                            }
                        ]
                    },
                    order_details: [
                        {
                            title: 'Plain Atta',
                            quantity: 1,
                            amount: '65.00',
                            currency: 'INR',
                            status: 'Completed',
                            item_id: 'id_13owvn_0_0'
                        }
                    ]
                };
                
                console.log('📋 Mock order data with CLOSED issue:', mockOrderData);
                
                if (window.orderDetailsManager) {
                    window.orderDetailsManager.displayOrderDetails(mockOrderData);
                    console.log('✅ Displayed mock data with CLOSED issue - should NOT show close button and timeline should be 100% complete');
                } else {
                    console.log('❌ OrderDetailsManager not available');
                }
            };

            // Test function to simulate issue data
            window.testWithIssueData = function() {
                console.log('🧪 Testing with simulated issue data...');
                
                const mockOrderData = {
                    order_id: 142,
                    transaction_id: 'efbb4c5b-c6b1-4011-a593-51a446a2c009',
                    ondc_order_id: 'O1758991924225',
                    order_status: 'Completed',
                    total_value: '145.00',
                    currency: 'INR',
                    payment_status: 'NOT-PAID',
                    payment_mode: 'ON-Fulfillment',
                    provider_id: 'pramaan_provider_1',
                    provider_location_id: 'SSL1',
                    total_items: 1,
                    total_quantity: '1',
                    created_at: '2025-09-27 16:50:03',
                    updated_at: '2025-09-27 22:20:04',
                    issue_raised: 1,
                    issue_details_status: 'PROCESSING',
                    issue_id: 'ISSUE-142-84',
                    issue_actions: {
                        action_status: 'RESOLUTION_PROPOSED'
                    },
                    issue_details: {
                        status: 'PROCESSING',
                        description: 'Product quality issue - item received was damaged',
                        category: 'ITEM',
                        sub_category: 'QUALITY',
                        created_at: '2025-09-27 18:30:00',
                        updated_at: '2025-09-27 22:20:04',
                        resolutions: [
                            {
                                descriptor: {
                                    short_desc: 'We apologize for the inconvenience. We have reviewed your issue and propose to replace the damaged item with a brand new product at no additional cost. Please confirm your acceptance to proceed with the replacement.'
                                },
                                type: 'REPLACEMENT',
                                description: 'Replace the damaged item with a new one of the same specification',
                                amount: '65.00',
                                currency: 'INR',
                                timeline: '3-5 business days'
                            },
                            {
                                descriptor: {
                                    code: 'RESOLUTION_DETAILS',
                                    short_desc: 'Detailed resolution information including refund amount, replacement timeline, and additional compensation for the inconvenience caused.'
                                },
                                tags: {
                                    list: [
                                        {
                                            descriptor: {
                                                code: 'REFUND_AMOUNT',
                                                name: 'Refund Amount'
                                            },
                                            value: '₹65.00'
                                        },
                                        {
                                            descriptor: {
                                                code: 'REPLACEMENT_TIMELINE',
                                                name: 'Replacement Timeline'
                                            },
                                            value: '3-5 business days'
                                        },
                                        {
                                            descriptor: {
                                                code: 'COMPENSATION',
                                                name: 'Additional Compensation'
                                            },
                                            value: '₹10.00 credit for future orders'
                                        }
                                    ]
                                }
                            }
                        ],
                        actions: [
                            {
                                descriptor: { code: 'RESOLUTION_PROPOSED' },
                                action_type: 'RESOLUTION_PROPOSED',
                                description: 'Seller has proposed a replacement for the damaged item',
                                status: 'PENDING_BUYER_RESPONSE',
                                created_at: '2025-09-27 22:20:04'
                            },
                            {
                                descriptor: { code: 'INFO_PROVIDED' },
                                action_type: 'INFO_PROVIDED',
                                description: 'Buyer provided additional information and images',
                                status: 'COMPLETED',
                                created_at: '2025-09-27 21:00:00'
                            },
                            {
                                descriptor: { code: 'INFO_REQUESTED' },
                                action_type: 'INFO_REQUESTED',
                                description: 'Additional information requested from buyer',
                                status: 'COMPLETED',
                                created_at: '2025-09-27 20:15:00'
                            },
                            {
                                descriptor: { code: 'ISSUE_RAISED' },
                                action_type: 'ISSUE_RAISED',
                                description: 'Issue raised by buyer regarding product quality',
                                status: 'COMPLETED',
                                created_at: '2025-09-27 18:30:00'
                            }
                        ]
                    },
                    order_details: [
                        {
                            title: 'Plain Atta',
                            quantity: 1,
                            amount: '65.00',
                            currency: 'INR',
                            status: 'Completed',
                            item_id: 'id_13owvn_0_0'
                        }
                    ]
                };
                
                console.log('📋 Mock order data with issues:', mockOrderData);
                
                if (window.orderDetailsManager) {
                    window.orderDetailsManager.displayOrderDetails(mockOrderData);
                    console.log('✅ Displayed mock data with issue details');
                } else {
                    console.log('❌ OrderDetailsManager not available');
                }
            };

            // Test function for Close Issue API
            window.testCloseIssueAPI = async function(transactionId) {
                console.log('🧪 Testing Close Issue API connectivity...');
                
                const apiUrl = 'https://neo-server.rozana.in/issues/close';
                const requestData = { 
                    transaction_id: transactionId || '121dbfa1-2c75-47c7-b05e-c1a3b8d958b4'
                };
                
                console.log('📡 Testing API:', apiUrl);
                console.log('📦 Request data:', requestData);
                console.log('🌐 Current protocol:', window.location.protocol);
                console.log('🌐 Current origin:', window.location.origin);
                
                // Test different methods
                const methods = [
                    {
                        name: 'Direct API (CORS)',
                        test: async () => {
                            return await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'cors',
                                credentials: 'omit',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json',
                                    'Cache-Control': 'no-cache'
                                },
                                body: JSON.stringify(requestData)
                            });
                        }
                    },
                    {
                        name: 'No-CORS Mode',
                        test: async () => {
                            return await fetch(apiUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });
                        }
                    }
                ];
                
                for (const method of methods) {
                    try {
                        console.log(`🔄 Testing ${method.name}...`);
                        const response = await method.test();
                        console.log(`✅ ${method.name} - Status:`, response.status, 'Type:', response.type);
                        
                        if (response.ok || response.type === 'opaque') {
                            console.log(`🎉 ${method.name} appears to be working!`);
                            if (response.type !== 'opaque') {
                                try {
                                    const result = await response.text();
                                    console.log(`📄 ${method.name} Response:`, result);
                                } catch (e) {
                                    console.log(`📄 ${method.name} Response could not be read:`, e.message);
                                }
                            }
                        }
                    } catch (error) {
                        console.log(`❌ ${method.name} failed:`, error.message);
                    }
                }
                
                console.log('🧪 Close Issue API connectivity test completed. Check console for details.');
            };

            // Simple test function for debugging Close Issue API
            window.debugCloseIssue = async function(transactionId = '121dbfa1-2c75-47c7-b05e-c1a3b8d958b4') {
                console.log('🔧 DEBUG: Testing Close Issue API directly...');
                
                const apiUrl = 'https://neo-server.rozana.in/issues/close';
                const requestData = { transaction_id: transactionId };
                
                console.log('🔗 API URL:', apiUrl);
                console.log('📦 Request Data:', requestData);
                console.log('🌐 Environment:', {
                    protocol: window.location.protocol,
                    origin: window.location.origin,
                    userAgent: navigator.userAgent.substring(0, 100) + '...'
                });
                
                try {
                    console.log('🚀 Making direct fetch request...');
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    console.log('📡 Response received:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    
                    const responseText = await response.text();
                    console.log('📄 Raw response text:', responseText);
                    
                    try {
                        const responseJson = JSON.parse(responseText);
                        console.log('✅ Parsed JSON response:', responseJson);
                        return { success: true, data: responseJson, status: response.status };
                    } catch (parseError) {
                        console.log('❌ Failed to parse JSON:', parseError.message);
                        return { success: false, error: 'Invalid JSON response', rawResponse: responseText, status: response.status };
                    }
                    
                } catch (error) {
                    console.log('❌ Fetch failed:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    return { success: false, error: error.message };
                }
            };

            // Test function to debug the specific transaction from the screenshot
            window.debugTransactionData = async function(transactionId = '8ce8b7da-732d-4398-b609-1caa8b7a69c7') {
                console.log('🔧 DEBUG: Fetching data for transaction:', transactionId);
                
                try {
                    const apiUrl = 'https://neo-server.rozana.in/searchOrder/';
                    const fullUrl = apiUrl + transactionId;
                    
                    console.log('🔗 API URL:', fullUrl);
                    
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ Full API Response:', data);
                        
                        // Specifically look for resolutions and refund data
                        if (data.issue_details?.resolutions) {
                            console.log('🔍 Resolutions found:', data.issue_details.resolutions);
                            
                            data.issue_details.resolutions.forEach((resolution, index) => {
                                console.log(`📋 Resolution[${index}]:`, resolution);
                                if (resolution.tags?.list) {
                                    console.log(`📋 Resolution[${index}] tags:`, resolution.tags.list);
                                }
                            });
                        } else {
                            console.log('❌ No resolutions found in issue_details');
                        }
                        
                        return data;
                    } else {
                        console.log('❌ API Error:', response.status, response.statusText);
                        return null;
                    }
                } catch (error) {
                    console.log('❌ Fetch failed:', error.message);
                    return null;
                }
            };

            // Simple test function for debugging Accept Proposal API
            window.debugAcceptProposal = async function(transactionId = '7fd329ac-00b6-46dd-933f-ec8d5caecec6') {
                console.log('🔧 DEBUG: Testing Accept Proposal API directly...');
                
                const apiUrl = 'https://neo-server.rozana.in/issues/accept-proposal';
                const requestData = { transaction_id: transactionId };
                
                console.log('🔗 API URL:', apiUrl);
                console.log('📦 Request Data:', requestData);
                console.log('🌐 Environment:', {
                    protocol: window.location.protocol,
                    origin: window.location.origin,
                    userAgent: navigator.userAgent.substring(0, 100) + '...'
                });
                
                try {
                    console.log('🚀 Making direct fetch request...');
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    console.log('📡 Response received:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    
                    const responseText = await response.text();
                    console.log('📄 Raw response text:', responseText);
                    
                    try {
                        const responseJson = JSON.parse(responseText);
                        console.log('✅ Parsed JSON response:', responseJson);
                        return { success: true, data: responseJson, status: response.status };
                    } catch (parseError) {
                        console.log('❌ Failed to parse JSON:', parseError.message);
                        return { success: false, error: 'Invalid JSON response', rawResponse: responseText, status: response.status };
                    }
                    
                } catch (error) {
                    console.log('❌ Fetch failed:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    return { success: false, error: error.message };
                }
            };
        });
    </script>
</body>
</html>
